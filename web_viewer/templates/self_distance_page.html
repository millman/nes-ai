{% extends "base.html" %}

{% block extra_head %}
<link rel="stylesheet" href="{{ url_for('static', filename='common_styles.css') }}">
<script src="https://cdn.plot.ly/plotly-2.27.0.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/PapaParse/5.4.1/papaparse.min.js"></script>
<script src="{{ url_for('static', filename='plotly_utils.js') }}"></script>
{% endblock %}

{% block body %}
<div class="d-flex align-items-center justify-content-between flex-wrap gap-2 mb-3">
    <div>
        {% if experiment %}
        <h3 class="mb-1">{{ experiment.title if experiment.title != "Untitled" else "Untitled" }} <small class="text-muted">({{ experiment.id }})</small></h3>
        {% else %}
        <h3 class="mb-1">{{ page_title if page_title is defined else "Self-distance" }}</h3>
        <div class="text-muted small">No experiments with {{ csv_name if csv_name is defined else "self_distance.csv" }}</div>
        {% endif %}
    </div>
    {% if experiment %}
    <div class="d-flex align-items-center gap-2 flex-wrap">
        <a class="btn btn-outline-secondary btn-sm" href="{{ url_for('experiment_detail', exp_id=experiment.id) }}">Open experiment</a>
    </div>
    {% endif %}
</div>

{% if not experiment %}
<div class="text-muted fst-italic">No {{ csv_name if csv_name is defined else "self_distance.csv" }} found in any experiments.</div>
{% else %}
<div class="small text-muted mb-2">
    Loaded from {{ csv_file.name if csv_file is defined else "self_distance.csv" }}{% if images_list %}, latest PNG in {{ images_folder if images_folder is defined else "vis_self_distance" }}{% endif %}.
</div>
<div class="row gy-1 gx-3 mt-3">
    <div class="col-12 col-lg-4">
        <div id="self-distance-first-plot" class="plot-area self-distance-plot"></div>
    </div>
    <div class="col-12 col-lg-4">
        <div id="self-distance-prior-plot" class="plot-area self-distance-plot"></div>
    </div>
    <div class="col-12 col-lg-4">
        <div id="self-distance-scatter-plot" class="plot-area self-distance-plot"></div>
    </div>
</div>
<div class="row gy-1 gx-3 mt-1">
    <div class="col-12 col-lg-4">
        <div id="self-distance-first-plot-cos" class="plot-area self-distance-plot"></div>
    </div>
    <div class="col-12 col-lg-4">
        <div id="self-distance-prior-plot-cos" class="plot-area self-distance-plot"></div>
    </div>
    <div class="col-12 col-lg-4">
        <div id="self-distance-scatter-plot-cos" class="plot-area self-distance-plot"></div>
    </div>
</div>
<div class="row g-3 mt-3" id="self-distance-frame-row">
    <div class="col-12 col-md-4">
        <div class="card h-100">
            <div class="card-header py-2">First frame</div>
            <div class="card-body d-flex flex-column align-items-center">
                <img id="self-distance-first-img" class="img-fluid rounded border d-none" alt="First frame preview">
                <div class="text-muted small mt-2" id="self-distance-first-label"></div>
                <div class="text-muted small" id="self-distance-first-action"></div>
            </div>
        </div>
    </div>
    <div class="col-12 col-md-4">
        <div class="card h-100">
            <div class="card-header py-2">Prior frame</div>
            <div class="card-body d-flex flex-column align-items-center">
                <img id="self-distance-prior-img" class="img-fluid rounded border d-none" alt="Prior frame preview">
                <div class="text-muted small mt-2" id="self-distance-prior-label"></div>
                <div class="text-muted small" id="self-distance-prior-action"></div>
            </div>
        </div>
    </div>
    <div class="col-12 col-md-4">
        <div class="card h-100">
            <div class="card-header py-2">Current frame</div>
            <div class="card-body d-flex flex-column align-items-center">
                <img id="self-distance-current-img" class="img-fluid rounded border d-none" alt="Current frame preview">
                <div class="text-muted small mt-2" id="self-distance-current-label"></div>
                <div class="text-muted small" id="self-distance-current-action"></div>
            </div>
        </div>
    </div>
</div>
<div class="d-flex align-items-center justify-content-between mb-2 mt-4">
    <h6 class="mb-0">Training metrics (loss)</h6>
</div>
<div class="plot-pin-wrapper mb-3" id="self-distance-loss-wrapper">
    <button
        type="button"
        class="plot-pin-btn"
        id="self-distance-loss-pin"
        aria-pressed="false"
        aria-label="Pin training metrics plot"
        title="Pin training metrics plot"
    >
        <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="currentColor" viewBox="0 0 16 16">
            <path d="M4.146.146A.5.5 0 0 1 4.5 0h7a.5.5 0 0 1 .5.5c0 .68-.342 1.174-.646 1.479-.126.125-.25.224-.354.298v4.431l.078.048c.203.127.476.314.751.555C12.36 7.775 13 8.527 13 9.5a.5.5 0 0 1-.5.5h-4v4.5c0 .276-.224 1.5-.5 1.5s-.5-1.224-.5-1.5V10h-4a.5.5 0 0 1-.5-.5c0-.973.64-1.725 1.17-2.189A6 6 0 0 1 5 6.708V2.277a3 3 0 0 1-.354-.298C4.342 1.674 4 1.179 4 .5a.5.5 0 0 1 .146-.354"/>
        </svg>
    </button>
    <div id="self-distance-loss-plot" class="plot-pin-plot"></div>
</div>
<div class="card mt-3">
    <div class="card-header py-2 d-flex justify-content-between align-items-center">
        <span class="image-preview-card-title">Self-distance image</span>
        <div class="d-flex align-items-center gap-2">
            <span class="text-muted small">Step: <span class="step-label-value" id="self-distance-step-label">â€”</span></span>
            <span class="diagnostic-info-icon" data-bs-toggle="tooltip" data-bs-placement="left" title="Self-distance image summary across steps. Read: distances to first/prior should change smoothly. Good: stable scale with few sharp spikes or sudden drift.">i</span>
        </div>
    </div>
    <div class="card-body d-flex flex-column gap-2 align-items-start">
        <img id="self-distance-step-img" class="img-fluid rounded border d-none" alt="Self-distance step">
    </div>
</div>
{% endif %}
{% endblock %}

{% block extra_scripts %}
{% if experiment %}
<script defer src="{{ url_for('static', filename='self_distance_common.js') }}"></script>
<script>
document.addEventListener("DOMContentLoaded", () => {
    const select = document.getElementById("self-distance-select");
    if (select) {
        select.addEventListener("change", () => {
            const id = select.value;
            window.location.href = "{{ redirect_url_base if redirect_url_base is defined else url_for('self_distance_z') }}/" + encodeURIComponent(id);
        });
    }

    const SELF_DISTANCE_CONFIG = {
        csvUrl: "{{ csv_url if csv_url is defined else '' }}",
        redirectUrl: "{{ redirect_url_base if redirect_url_base is defined else url_for('self_distance_z') }}/",
        errorMessage: "{{ csv_name if csv_name is defined else 'self_distance.csv' }}",
    };

    const selfDistanceMap = {};
    {% if images_list %}
    {% for img in images_list %}
    {% if "cosine" not in img.stem %}
    {% set rel_img = img.relative_to(experiment.path) %}
    {% set stem = img.stem.split('_')|last %}
    {% set step = stem|int %}
    selfDistanceMap[{{ step }}] = {
        url: "{{ url_for('serve_asset', relative_path=experiment.id ~ '/' ~ rel_img) }}",
        path: "{{ rel_img }}",
    };
    {% endif %}
    {% endfor %}
    {% endif %}
    const selfDistanceSteps = Object.keys(selfDistanceMap).map((k) => Number(k)).filter((n) => !Number.isNaN(n)).sort((a, b) => a - b);

    const serverData = {
        selfDistanceMap: selfDistanceMap,
        selfDistanceSteps: selfDistanceSteps,
        diagFigure: {{ figure | tojson if figure else 'null' }},
        initialStep: {{ experiment.rollout_steps[-1] if experiment.rollout_steps else 0 }},
        experimentId: "{{ experiment.id }}",
    };

    initializeSelfDistancePage(SELF_DISTANCE_CONFIG, serverData);
});
</script>

{% endif %}
{% endblock %}
