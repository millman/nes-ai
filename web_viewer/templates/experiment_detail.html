{% extends "base.html" %}

{% block extra_head %}
<script src="https://cdn.plot.ly/plotly-2.27.0.min.js"></script>
<script src="{{ url_for('static', filename='plotly_utils.js') }}"></script>
<script defer src="{{ url_for('static', filename='grid.js') }}"></script>
{% endblock %}

{% block body %}
{% set heading_title = experiment.title if experiment.title != "Untitled" else "Untitled" %}
<h3 class="mb-4">{{ heading_title }} <small class="text-muted">({{ experiment.id }})</small></h3>

<div id="detail-plot" class="plot-area mb-3">
    {% if figure %}
    <script>
                const IMAGE_FOLDER_OPTIONS = [
                    { value: "vis_fixed_0", label: "Rollouts:Fixed 0", prefix: "rollout_", folder: "vis_fixed_0" },
                    { value: "vis_fixed_1", label: "Rollouts:Fixed 1", prefix: "rollout_", folder: "vis_fixed_1" },
                    { value: "vis_rolling_0", label: "Rollouts:Rolling 0", prefix: "rollout_", folder: "vis_rolling_0" },
                    { value: "vis_rolling_1", label: "Rollouts:Rolling 1", prefix: "rollout_", folder: "vis_rolling_1" },
                    { value: "embeddings", label: "Embeddings:Sequence", prefix: "embeddings_", folder: "embeddings" },
                    { value: "samples_hard", label: "Samples:Hard", prefix: "hard_", folder: "samples_hard" },
                    { value: "vis_self_distance_z", label: "Self-distance:Distance (Z)", prefix: "self_distance_z_", folder: "vis_self_distance_z" },
                    { value: "vis_self_distance_s", label: "Self-distance:Distance (S)", prefix: "self_distance_s_", folder: "vis_self_distance_s" },
                    { value: "vis_delta_z_pca", label: "Diagnostics:Delta PCA (Z)", prefix: "delta_z_pca_", folder: "vis_delta_z_pca" },
                    { value: "vis_delta_s_pca", label: "Diagnostics:Delta PCA (S)", prefix: "delta_s_pca_", folder: "vis_delta_s_pca" },
                    { value: "vis_odometry_current_z", label: "Odometry:Cumulative sum of Δz PCA/ICA/t-SNE", prefix: "odometry_z_", folder: "vis_odometry" },
                    { value: "vis_odometry_current_s", label: "Odometry:Cumulative sum of Δs PCA/ICA/t-SNE", prefix: "odometry_s_", folder: "vis_odometry" },
                    { value: "vis_odometry_z_vs_z_hat", label: "Odometry:||z - z_hat|| + scatter", prefix: "z_vs_z_hat_", folder: "vis_odometry" },
                    { value: "vis_odometry_s_vs_s_hat", label: "Odometry:||s - s_hat|| + scatter", prefix: "s_vs_s_hat_", folder: "vis_odometry" },
                    { value: "vis_action_alignment_detail", label: "Diagnostics:Action alignment (Z)", prefix: "action_alignment_detail_", folder: "vis_action_alignment_z" },
                    { value: "vis_action_alignment_detail_s", label: "Diagnostics:Action alignment (S)", prefix: "action_alignment_detail_", folder: "vis_action_alignment_s" },
                    { value: "vis_cycle_error", label: "Diagnostics:Cycle error (Z)", prefix: "cycle_error_", folder: "vis_cycle_error_z" },
                    { value: "vis_cycle_error_s", label: "Diagnostics:Cycle error (S)", prefix: "cycle_error_", folder: "vis_cycle_error_s" },
                    { value: "vis_adjacency", label: "Adjacency:Graph", prefix: "adjacency_", folder: "vis_adjacency" },
                    { value: "vis_graph_rank1_cdf_z", label: "Graph Diagnostics:Rank-1 CDF (Z)", prefix: "rank1_cdf_", folder: "graph_diagnostics_z" },
                    { value: "vis_graph_rank2_cdf_z", label: "Graph Diagnostics:Rank-2 CDF (Z)", prefix: "rank2_cdf_", folder: "graph_diagnostics_z" },
                    { value: "vis_graph_neff_violin_z", label: "Graph Diagnostics:Neighborhood size (Z)", prefix: "neff_violin_", folder: "graph_diagnostics_z" },
                    { value: "vis_graph_in_degree_hist_z", label: "Graph Diagnostics:In-degree (Z)", prefix: "in_degree_hist_", folder: "graph_diagnostics_z" },
                    { value: "vis_graph_edge_consistency_z", label: "Graph Diagnostics:Edge consistency (Z)", prefix: "edge_consistency_", folder: "graph_diagnostics_z" },
                    { value: "vis_graph_metrics_history_z", label: "Graph Diagnostics:Metrics history (Z)", prefix: "metrics_history_", folder: "graph_diagnostics_z" },
                    { value: "vis_graph_rank1_cdf_s", label: "Graph Diagnostics:Rank-1 CDF (S)", prefix: "rank1_cdf_", folder: "graph_diagnostics_s" },
                    { value: "vis_graph_rank2_cdf_s", label: "Graph Diagnostics:Rank-2 CDF (S)", prefix: "rank2_cdf_", folder: "graph_diagnostics_s" },
                    { value: "vis_graph_neff_violin_s", label: "Graph Diagnostics:Neighborhood size (S)", prefix: "neff_violin_", folder: "graph_diagnostics_s" },
                    { value: "vis_graph_in_degree_hist_s", label: "Graph Diagnostics:In-degree (S)", prefix: "in_degree_hist_", folder: "graph_diagnostics_s" },
                    { value: "vis_graph_edge_consistency_s", label: "Graph Diagnostics:Edge consistency (S)", prefix: "edge_consistency_", folder: "graph_diagnostics_s" },
                    { value: "vis_graph_metrics_history_s", label: "Graph Diagnostics:Metrics history (S)", prefix: "metrics_history_", folder: "graph_diagnostics_s" },
                ].sort((a, b) => {
                    const groupA = a.label.split(":")[0].trim();
                    const groupB = b.label.split(":")[0].trim();
                    const groupCompare = groupA.localeCompare(groupB);
                    if (groupCompare !== 0) {
                        return groupCompare;
                    }
                    const labelCompare = a.label.localeCompare(b.label);
                    if (labelCompare !== 0) {
                        return labelCompare;
                    }
                    return a.value.localeCompare(b.value);
                });

                document.addEventListener("DOMContentLoaded", () => {
                    const figure = {{ figure|tojson }};
                    const rolloutSteps = {{ experiment.rollout_steps|tojson }};
                    const visualizationSteps = {{ visualization_steps|tojson }};
                    const plotEl = document.getElementById("detail-plot");
                    const folderSelect = document.getElementById("detail-folder-select");

                    // Populate folder selector to mirror comparison options.
                    if (folderSelect) {
                        folderSelect.innerHTML = "";
                        IMAGE_FOLDER_OPTIONS.forEach((opt) => {
                            const option = document.createElement("option");
                            option.value = opt.value;
                            option.textContent = opt.label;
                            folderSelect.appendChild(option);
                        });
                    }

                    // Restore folder from URL if valid.
                    const urlParams = new URLSearchParams(window.location.search);
                    const folderParam = urlParams.get("folder");
                    if (folderSelect) {
                        if (folderParam && IMAGE_FOLDER_OPTIONS.some((opt) => opt.value === folderParam)) {
                            folderSelect.value = folderParam;
                        } else {
                            folderSelect.value = "vis_fixed_0";
                        }
                    }

                    // Parse view state from URL
                    const xMin = urlParams.get("xmin");
                    const xMax = urlParams.get("xmax");
                    const yMin = urlParams.get("ymin");
                    const yMax = urlParams.get("ymax");

                    // Apply saved view state to figure layout
                    if (xMin !== null && xMax !== null) {
                        figure.layout.xaxis = figure.layout.xaxis || {};
                        figure.layout.xaxis.range = [parseFloat(xMin), parseFloat(xMax)];
                        figure.layout.xaxis.autorange = false;
                    }
                    if (yMin !== null && yMax !== null) {
                        figure.layout.yaxis = figure.layout.yaxis || {};
                        figure.layout.yaxis.range = [parseFloat(yMin), parseFloat(yMax)];
                        figure.layout.yaxis.autorange = false;
                    }

                    Plotly.react(plotEl, figure.data, figure.layout, buildPlotlyConfig(figure.config || {})).then(() => {
                        attachRolloutPreview(plotEl, "{{ experiment.id }}", "detail-rollout-preview", rolloutSteps, visualizationSteps);

                        // Save view state to URL on zoom/pan
                        plotEl.on("plotly_relayout", (eventData) => {
                            if (!eventData) return;
                            const url = new URL(window.location.href);

                            if (eventData["xaxis.autorange"] || eventData["yaxis.autorange"]) {
                                url.searchParams.delete("xmin");
                                url.searchParams.delete("xmax");
                                url.searchParams.delete("ymin");
                                url.searchParams.delete("ymax");
                            } else {
                                if (eventData["xaxis.range[0]"] !== undefined) {
                                    url.searchParams.set("xmin", eventData["xaxis.range[0]"]);
                                    url.searchParams.set("xmax", eventData["xaxis.range[1]"]);
                                }
                                if (eventData["yaxis.range[0]"] !== undefined) {
                                    url.searchParams.set("ymin", eventData["yaxis.range[0]"]);
                                    url.searchParams.set("ymax", eventData["yaxis.range[1]"]);
                                }
                            }

                            window.history.replaceState({}, "", url.toString());
                        });
                    });
                });
                function attachRolloutPreview(plotEl, expId, previewId, rolloutSteps, vizSteps) {
                    const preview = document.getElementById(previewId);
                    const folderSelect = document.getElementById("detail-folder-select");
                    const pathDisplay = document.querySelector(".rollout-path");
                    if (!plotEl || !preview || typeof Plotly === "undefined") {
                        return;
                    }

                    // Save folder to URL on change
                    if (folderSelect) {
                        folderSelect.addEventListener("change", () => {
                            const url = new URL(window.location.href);
                            url.searchParams.set("folder", folderSelect.value);
                            window.history.replaceState({}, "", url.toString());
                            renderLatest();
                        });
                    }

                    const getFolder = () => (folderSelect && folderSelect.value) || "vis_fixed_0";
                    const getPrefix = () => {
                        const opt = IMAGE_FOLDER_OPTIONS.find((o) => o.value === getFolder());
                        return opt ? opt.prefix : "rollout_";
                    };
                    const getFolderPath = () => {
                        const opt = IMAGE_FOLDER_OPTIONS.find((o) => o.value === getFolder());
                        return opt ? opt.folder || opt.value : getFolder();
                    };

                    const ensurePreviewStructure = () => {
                        if (preview.dataset.initialized === "1") {
                            return;
                        }
                        preview.innerHTML = `
                            <img class="img-fluid rounded border rollout-img d-none" alt="Rollout preview">
                            <div class="text-muted fst-italic rollout-missing d-none">No rollout image available.</div>
                        `;
                        preview.dataset.initialized = "1";
                    };
                    ensurePreviewStructure();
                    const pathEl = () => pathDisplay;
                    const imgEl = () => preview.querySelector(".rollout-img");
                    const missingEl = () => preview.querySelector(".rollout-missing");
                    const nearestStep = (target, list) => {
                        if (!Array.isArray(list) || list.length === 0) {
                            return null;
                        }
                        let best = null;
                        for (let i = 0; i < list.length; i++) {
                            const step = list[i];
                            if (step > target) {
                                continue;
                            }
                            if (best === null || step > best) {
                                best = step;
                            }
                        }
                        return best;
                    };
                    const render = (step) => {
                        const target = Math.max(0, Math.round(step));
                        const folder = getFolder();
                        const folderSteps = (vizSteps && vizSteps[folder]) || (vizSteps && vizSteps.__fallback) || rolloutSteps || [];
                        const matched = nearestStep(target, folderSteps);
                        if (matched === null) {
                            const miss = missingEl();
                            const img = imgEl();
                            const path = pathEl();
                            if (path) {
                                path.textContent = "No images available.";
                            }
                            if (img) {
                                img.classList.add("d-none");
                            }
                            if (miss) {
                                miss.textContent = "No images available.";
                                miss.classList.remove("d-none");
                            }
                            return;
                        }
                        const prefix = getPrefix();
                        const folderPath = getFolderPath();
                        const filename = `${prefix}${matched.toString().padStart(7, "0")}.png`;
                        const src = `/assets/${expId}/${folderPath}/${filename}`;
                        const path = pathEl();
                        const img = imgEl();
                        const miss = missingEl();
                        if (path) {
                            path.textContent = `${folderPath}/${filename} (hovered ${target}, showing ${matched})`;
                        }
                        if (img) {
                            img.src = src;
                            img.alt = `${folderPath} ${matched}`;
                            img.dataset.step = String(matched);
                            img.classList.remove("d-none");
                            img.onerror = () => {
                                img.classList.add("d-none");
                                if (miss) {
                                    miss.textContent = `No image for step ${matched}`;
                                    miss.classList.remove("d-none");
                                }
                            };
                            img.onload = () => {
                                if (miss) {
                                    miss.classList.add("d-none");
                                }
                            };
                        }
                        if (miss) {
                            miss.classList.add("d-none");
                        }
                    };
                    plotEl.on("plotly_hover", (event) => {
                        const point = event?.points?.[0];
                        if (!point || typeof point.x === "undefined") {
                            return;
                        }
                        render(point.x);
                    });
                    const renderLatest = () => {
                        const folder = getFolder();
                        const stepsForFolder =
                            (vizSteps && vizSteps[folder]) || (vizSteps && vizSteps.__fallback) || rolloutSteps || [];
                        const lastStep = Array.isArray(stepsForFolder) && stepsForFolder.length
                            ? stepsForFolder[stepsForFolder.length - 1]
                            : null;
                        if (lastStep !== null) {
                            render(lastStep);
                            return;
                        }
                        const allX = Array.isArray(plotEl.data)
                            ? plotEl.data.flatMap((trace) => Array.isArray(trace.x) ? trace.x : []).filter((v) => v !== null && v !== undefined)
                            : [];
                        if (allX.length) {
                            const latest = Math.max(...allX.map((v) => Number(v) || 0));
                            render(latest);
                        }
                    };
                    renderLatest();
                }
    </script>
    {% else %}
    <p class="text-muted fst-italic">No metrics available for this experiment.</p>
    {% endif %}
</div>

        <div class="mb-4">
            <div class="d-flex align-items-center gap-2 mb-2 flex-wrap">
                <label class="form-label mb-0 small text-muted" for="detail-folder-select">Image folder:</label>
                <select id="detail-folder-select" class="form-select form-select-sm" style="width: auto;">
                    <option value="vis_adjacency">Adjacency:Graph</option>
                    <option value="vis_action_alignment_detail_s">Diagnostics:Action alignment (S)</option>
                    <option value="vis_action_alignment_detail">Diagnostics:Action alignment (Z)</option>
                    <option value="vis_cycle_error_s">Diagnostics:Cycle error (S)</option>
                    <option value="vis_cycle_error">Diagnostics:Cycle error (Z)</option>
                    <option value="vis_delta_s_pca">Diagnostics:Delta PCA (S)</option>
                    <option value="vis_delta_z_pca">Diagnostics:Delta PCA (Z)</option>
                    <option value="embeddings">Embeddings:Sequence</option>
                    <option value="vis_graph_edge_consistency_s">Graph Diagnostics:Edge consistency (S)</option>
                    <option value="vis_graph_edge_consistency_z">Graph Diagnostics:Edge consistency (Z)</option>
                    <option value="vis_graph_in_degree_hist_s">Graph Diagnostics:In-degree (S)</option>
                    <option value="vis_graph_in_degree_hist_z">Graph Diagnostics:In-degree (Z)</option>
                    <option value="vis_graph_metrics_history_s">Graph Diagnostics:Metrics history (S)</option>
                    <option value="vis_graph_metrics_history_z">Graph Diagnostics:Metrics history (Z)</option>
                    <option value="vis_graph_neff_violin_s">Graph Diagnostics:Neighborhood size (S)</option>
                    <option value="vis_graph_neff_violin_z">Graph Diagnostics:Neighborhood size (Z)</option>
                    <option value="vis_graph_rank1_cdf_s">Graph Diagnostics:Rank-1 CDF (S)</option>
                    <option value="vis_graph_rank1_cdf_z">Graph Diagnostics:Rank-1 CDF (Z)</option>
                    <option value="vis_graph_rank2_cdf_s">Graph Diagnostics:Rank-2 CDF (S)</option>
                    <option value="vis_graph_rank2_cdf_z">Graph Diagnostics:Rank-2 CDF (Z)</option>
                    <option value="vis_odometry_current_s">Odometry:Cumulative sum of Δs PCA/ICA/t-SNE</option>
                    <option value="vis_odometry_current_z">Odometry:Cumulative sum of Δz PCA/ICA/t-SNE</option>
                    <option value="vis_odometry_s_vs_s_hat">Odometry:||s - s_hat|| + scatter</option>
                    <option value="vis_odometry_z_vs_z_hat">Odometry:||z - z_hat|| + scatter</option>
                    <option value="vis_fixed_0">Rollouts:Fixed 0</option>
                    <option value="vis_fixed_1">Rollouts:Fixed 1</option>
                    <option value="vis_rolling_0">Rollouts:Rolling 0</option>
                    <option value="vis_rolling_1">Rollouts:Rolling 1</option>
                    <option value="samples_hard">Samples:Hard</option>
                    <option value="vis_self_distance_s">Self-distance:Distance (S)</option>
                    <option value="vis_self_distance_z">Self-distance:Distance (Z)</option>
                </select>
                <div class="small text-muted rollout-path mb-0">Hover a point to preview rollout.</div>
            </div>
            <div id="detail-rollout-preview" class="mt-0"></div>
        </div>

        <div class="table-responsive">
            <table class="table table-bordered align-top exp-table">
                <colgroup>
                    <col data-col-id="notes">
                    <col data-col-id="name">
                    <col data-col-id="metadata">
                    <col data-col-id="metadata_git">
                    <col data-col-id="image">
                </colgroup>
                <thead class="table-light">
                <tr>
                    <th data-col-id="notes">Notes</th>
                    <th data-col-id="name">Experiment</th>
                    <th data-col-id="metadata">metadata.txt</th>
                    <th data-col-id="metadata_git">metadata_git.txt</th>
                    <th data-col-id="image">metrics/loss_curves.png</th>
                </tr>
                </thead>
                <tbody>
                <tr data-exp-id="{{ experiment.id }}">
                    <td class="notes-cell" data-col-id="notes">
                        <form class="notes-form d-flex flex-column h-100" data-exp-id="{{ experiment.id }}">
                            <textarea class="form-control font-monospace flex-grow-1 mb-2" rows="6" placeholder="Add experiment notes...">{{- experiment.notes_text -}}</textarea>
                            <div class="d-flex align-items-center gap-2">
                                <button type="button" class="btn btn-primary btn-sm save-notes">Save</button>
                                <span class="notes-status small text-muted" aria-live="polite"></span>
                            </div>
                        </form>
                    </td>
                    <td data-col-id="name" class="experiment-cell">
                        {% set title_value = "" if experiment.title == "Untitled" else experiment.title %}
                        <form class="title-form inline-field-form inline-field-group" data-exp-id="{{ experiment.id }}">
                            <div class="input-group input-group-sm title-input-group inline-field-group w-100">
                                <input
                                    type="text"
                                    class="form-control form-control-sm exp-title-input inline-field"
                                    value="{{ title_value }}"
                                    placeholder="Untitled"
                                    aria-label="Experiment title"
                                    readonly
                                >
                            </div>
                            <span class="title-status small text-muted" aria-live="polite"></span>
                        </form>
                        <div class="fw-semibold">{{ experiment.name }}</div>
                        <div class="font-monospace text-muted small mt-1">{{ experiment.git_commit }}</div>
                        <div class="text-muted small mt-1">
                            Parameters: <span class="font-monospace format-params" data-value="{{ experiment.total_params if experiment.total_params is not none else '' }}">-</span>
                        </div>
                        <div class="text-muted small">
                            FLOPs/step: <span class="font-monospace format-flops" data-value="{{ experiment.flops_per_step if experiment.flops_per_step is not none else '' }}">-</span>
                        </div>
                    </td>
                    <td data-col-id="metadata">
                        <div class="metadata-wrapper card card-body p-2" data-exp-id="{{ experiment.id }}">
                            <pre class="metadata-block">{{ experiment.metadata_text }}</pre>
                        </div>
                        <button type="button" class="btn btn-sm btn-outline-secondary mt-2 metadata-toggle" data-target="{{ experiment.id }}">Expand</button>
                    </td>
                    <td data-col-id="metadata_git">
                        <div class="metadata-wrapper card card-body p-2" data-exp-id="{{ experiment.id }}-git">
                            <pre class="metadata-block">{{ experiment.git_metadata_text }}</pre>
                        </div>
                        <button type="button" class="btn btn-sm btn-outline-secondary mt-2 metadata-toggle" data-target="{{ experiment.id }}-git">Expand</button>
                    </td>
                    <td class="image-cell" data-col-id="image">
                        {% if experiment.loss_image %}
                        <img src="{{ url_for('serve_asset', relative_path=experiment.id ~ '/metrics/loss_curves.png') }}" alt="Loss curves for {{ experiment.name }}" class="img-fluid rounded border h-100 w-100 object-fit-contain">
                        {% else %}
                        <div class="text-muted fst-italic">metrics/loss_curves.png missing</div>
                        {% endif %}
                    </td>
                </tr>
                </tbody>
            </table>
        </div>
    </div>
</div>
{% endblock %}
