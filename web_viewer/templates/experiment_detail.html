{% extends "base.html" %}

{% block extra_head %}
<script src="https://cdn.plot.ly/plotly-2.27.0.min.js"></script>
<script defer src="{{ url_for('static', filename='grid.js') }}"></script>
{% endblock %}

{% block body %}
<a href="{{ url_for('experiments_index') }}" class="btn btn-outline-secondary btn-sm mb-3">&larr; Back to all experiments</a>
{% set heading_title = experiment.title if experiment.title != "Untitled" else "Untitled" %}
<h2 class="mb-4">{{ heading_title }} <small class="text-muted">({{ experiment.name }})</small></h2>

<div class="card mb-3">
    <div class="card-body">
        <div id="detail-plot" class="plot-area">
            {% if figure %}
            <script>
                document.addEventListener("DOMContentLoaded", () => {
                    const figure = {{ figure|tojson }};
                    const rolloutSteps = {{ experiment.rollout_steps|tojson }};
                    const plotEl = document.getElementById("detail-plot");
                    Plotly.react(plotEl, figure.data, figure.layout, figure.config || {}).then(() => {
                        attachRolloutPreview(plotEl, "{{ experiment.id }}", "detail-rollout-preview", rolloutSteps);
                    });
                });
                function attachRolloutPreview(plotEl, expId, previewId, steps) {
                    const preview = document.getElementById(previewId);
                    if (!plotEl || !preview || typeof Plotly === "undefined") {
                        return;
                    }
                    const ensurePreviewStructure = () => {
                        if (preview.dataset.initialized === "1") {
                            return;
                        }
                        preview.innerHTML = `
                            <div class="small text-muted mb-1 rollout-path">Hover a point to preview rollout.</div>
                            <img class="img-fluid rounded border rollout-img d-none" alt="Rollout preview">
                            <div class="text-muted fst-italic rollout-missing d-none">No rollout image available.</div>
                        `;
                        preview.dataset.initialized = "1";
                    };
                    ensurePreviewStructure();
                    const pathEl = () => preview.querySelector(".rollout-path");
                    const imgEl = () => preview.querySelector(".rollout-img");
                    const missingEl = () => preview.querySelector(".rollout-missing");
                    const nearestStep = (target, list) => {
                        if (!Array.isArray(list) || list.length === 0) {
                            return null;
                        }
                        let best = null;
                        for (let i = 0; i < list.length; i++) {
                            const step = list[i];
                            if (step > target) {
                                continue;
                            }
                            if (best === null || step > best) {
                                best = step;
                            }
                        }
                        return best;
                    };
                    const render = (step) => {
                        const target = Math.max(0, Math.round(step));
                        const matched = nearestStep(target, steps);
                        if (matched === null) {
                            const miss = missingEl();
                            const img = imgEl();
                            const path = pathEl();
                            if (path) {
                                path.textContent = "No rollout images available.";
                            }
                            if (img) {
                                img.classList.add("d-none");
                            }
                            if (miss) {
                                miss.textContent = "No rollout images available.";
                                miss.classList.remove("d-none");
                            }
                            return;
                        }
                        const filename = `rollout_${matched.toString().padStart(7, "0")}.png`;
                        // Rollouts are saved under vis_fixed_<idx>/, use the first sample (0) for preview.
                        const src = `/assets/${expId}/vis_fixed_0/${filename}`;
                        const path = pathEl();
                        const img = imgEl();
                        const miss = missingEl();
                        if (path) {
                            path.textContent = `vis_fixed_0/${filename} (hovered ${target}, showing ${matched})`;
                        }
                        if (img) {
                            img.src = src;
                            img.alt = `Rollout ${matched}`;
                            img.dataset.step = String(matched);
                            img.classList.remove("d-none");
                            img.onerror = () => {
                                img.classList.add("d-none");
                                if (miss) {
                                    miss.textContent = `No rollout image for step ${matched}`;
                                    miss.classList.remove("d-none");
                                }
                            };
                            img.onload = () => {
                                if (miss) {
                                    miss.classList.add("d-none");
                                }
                            };
                        }
                        if (miss) {
                            miss.classList.add("d-none");
                        }
                    };
                    plotEl.on("plotly_hover", (event) => {
                        const point = event?.points?.[0];
                        if (!point || typeof point.x === "undefined") {
                            return;
                        }
                        render(point.x);
                    });
                }
            </script>
            {% else %}
            <p class="text-muted fst-italic">No metrics available for this experiment.</p>
            {% endif %}
        </div>
    </div>
</div>

<div class="card mb-4">
    <div class="card-body">
        <div id="detail-rollout-preview" class="mt-0"></div>
    </div>
</div>

<div class="table-responsive">
    <table class="table table-bordered align-top exp-table">
        <colgroup>
            <col data-col-id="notes">
            <col data-col-id="name">
            <col data-col-id="metadata">
            <col data-col-id="image">
        </colgroup>
        <thead class="table-light">
        <tr>
            <th data-col-id="notes">Notes</th>
            <th data-col-id="name">Experiment</th>
            <th data-col-id="metadata">metadata.txt</th>
            <th data-col-id="image">metrics/loss_curves.png</th>
        </tr>
        </thead>
        <tbody>
        <tr data-exp-id="{{ experiment.id }}">
            <td class="notes-cell" data-col-id="notes">
                <form class="notes-form d-flex flex-column h-100" data-exp-id="{{ experiment.id }}">
                    <textarea class="form-control font-monospace flex-grow-1 mb-2" rows="6" placeholder="Add experiment notes...">{{- experiment.notes_text -}}</textarea>
                    <div class="d-flex align-items-center gap-2">
                        <button type="button" class="btn btn-primary btn-sm save-notes">Save</button>
                        <span class="notes-status small text-muted" aria-live="polite"></span>
                    </div>
                </form>
            </td>
            <td data-col-id="name" class="experiment-cell">
                {% set title_value = "" if experiment.title == "Untitled" else experiment.title %}
                <form class="title-form" data-exp-id="{{ experiment.id }}">
                    <div class="input-group input-group-sm title-input-group">
                        <input
                            type="text"
                            class="form-control form-control-sm exp-title-input"
                            value="{{ title_value }}"
                            placeholder="Untitled"
                            aria-label="Experiment title"
                            readonly
                        >
                    </div>
                    <span class="title-status small text-muted" aria-live="polite"></span>
                </form>
                <div class="fw-semibold">{{ experiment.name }}</div>
                <div class="font-monospace text-muted small mt-1">{{ experiment.git_commit }}</div>
            </td>
            <td data-col-id="metadata">
                <div class="metadata-wrapper card card-body p-2" data-exp-id="{{ experiment.id }}">
                    <pre class="metadata-block">{{ experiment.metadata_text }}</pre>
                </div>
                <button type="button" class="btn btn-sm btn-outline-secondary mt-2 metadata-toggle" data-target="{{ experiment.id }}">Expand</button>
            </td>
            <td class="image-cell" data-col-id="image">
                {% if experiment.loss_image %}
                <img src="{{ url_for('serve_asset', relative_path=experiment.id ~ '/metrics/loss_curves.png') }}" alt="Loss curves for {{ experiment.name }}" class="img-fluid rounded border h-100 w-100 object-fit-contain">
                {% else %}
                <div class="text-muted fst-italic">metrics/loss_curves.png missing</div>
                {% endif %}
            </td>
        </tr>
        </tbody>
    </table>
</div>
{% endblock %}
