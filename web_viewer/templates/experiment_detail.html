{% extends "base.html" %}

{% block extra_head %}
<script src="https://cdn.plot.ly/plotly-2.27.0.min.js"></script>
<script defer src="{{ url_for('static', filename='grid.js') }}"></script>
{% endblock %}

{% block body %}
<a href="{{ url_for('experiments_index') }}">&larr; Back to all experiments</a>
{% set heading_title = experiment.title if experiment.title != "Untitled" else "Untitled" %}
<h2 class="detail-heading">{{ heading_title }} ({{ experiment.name }})</h2>

<section class="plot-wrapper">
    <div id="detail-plot" class="plot-area detail-plot">
        {% if figure %}
        <script>
            document.addEventListener("DOMContentLoaded", () => {
                const figure = {{ figure|tojson }};
                Plotly.react("detail-plot", figure.data, figure.layout, figure.config || {});
            });
        </script>
        {% else %}
        <p class="empty-state">No metrics available for this experiment.</p>
        {% endif %}
    </div>
</section>

<section>
    <table class="exp-table">
        <colgroup>
            <col data-col-id="notes">
            <col data-col-id="name">
            <col data-col-id="metadata">
            <col data-col-id="image">
        </colgroup>
        <thead>
        <tr>
            <th data-col-id="notes">Notes</th>
            <th data-col-id="name">Experiment</th>
            <th data-col-id="metadata">metadata.txt</th>
            <th data-col-id="image">metrics/loss_curves.png</th>
        </tr>
        </thead>
        <tbody>
        <tr data-exp-id="{{ experiment.id }}">
            <td class="notes-cell" data-col-id="notes">
                <form class="notes-form" data-exp-id="{{ experiment.id }}">
                    <textarea rows="6" placeholder="Add experiment notes...">{{- experiment.notes_text -}}</textarea>
                    <div class="notes-actions">
                        <button type="button" class="save-notes">Save</button>
                        <span class="notes-status" aria-live="polite"></span>
                    </div>
                </form>
            </td>
            <td data-col-id="name">
                {% set title_value = "" if experiment.title == "Untitled" else experiment.title %}
                <form class="title-form" data-exp-id="{{ experiment.id }}">
                    <input
                        type="text"
                        class="exp-title-input"
                        value="{{ title_value }}"
                        placeholder="Untitled"
                        aria-label="Experiment title"
                    >
                    <span class="title-status" aria-live="polite"></span>
                </form>
                <div class="exp-name">{{ experiment.name }}</div>
                <div class="exp-commit">{{ experiment.git_commit }}</div>
            </td>
            <td data-col-id="metadata">
                <pre class="metadata-block">{{ experiment.metadata_text }}</pre>
            </td>
            <td class="image-cell" data-col-id="image">
                {% if experiment.loss_image %}
                <img src="{{ url_for('serve_asset', relative_path=experiment.id ~ '/metrics/loss_curves.png') }}" alt="Loss curves for {{ experiment.name }}">
                {% else %}
                <div class="empty-state">metrics/loss_curves.png missing</div>
                {% endif %}
            </td>
        </tr>
        </tbody>
    </table>
</section>
{% endblock %}
