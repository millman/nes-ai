{% extends "base.html" %}

{% set steps = steps if steps is defined else [] %}
{% set step_count = steps|length %}

{% block extra_head %}
<script src="https://cdn.plot.ly/plotly-2.27.0.min.js"></script>
<script src="{{ url_for('static', filename='plotly_utils.js') }}"></script>
{% endblock %}

{% block body %}
<style>
.debug-grid {
    display: grid;
    grid-template-columns: repeat(2, minmax(0, 1fr));
    gap: 0.75rem 1rem;
}
.debug-card img {
    width: 100%;
    height: auto;
    border-radius: 0.5rem;
    border: 1px solid #e9ecef;
}
.debug-loss-wrapper {
    position: relative;
}
.debug-loss-plot {
    height: 220px;
}
.debug-pin-btn {
    position: absolute;
    bottom: 10px;
    right: 10px;
    width: 32px;
    height: 32px;
    border-radius: 999px;
    display: inline-flex;
    align-items: center;
    justify-content: center;
    background-color: rgba(255, 255, 255, 0.9);
    border: 1px solid #ced4da;
    color: #6c757d;
    z-index: 5;
    box-shadow: 0 2px 6px rgba(0, 0, 0, 0.08);
    transition: transform 0.15s ease-in-out, box-shadow 0.15s ease-in-out, background-color 0.15s ease-in-out, color 0.15s ease-in-out, border-color 0.15s ease-in-out;
}
.debug-pin-btn:hover {
    transform: translateY(-1px);
    box-shadow: 0 4px 10px rgba(0, 0, 0, 0.12);
}
.debug-pin-btn.active {
    background-color: #0d6efd;
    border-color: #0a58ca;
    color: #fff;
}
.debug-loss-wrapper.sticky-active {
    position: sticky;
    top: 0;
    z-index: 1030;
    background: #fff;
    border-radius: 0.5rem;
    box-shadow: 0 0.5rem 1rem rgba(0, 0, 0, 0.08);
}
.debug-info-icon {
    display: inline-flex;
    align-items: center;
    justify-content: center;
    width: 18px;
    height: 18px;
    border-radius: 999px;
    background: #eef2ff;
    color: #3949ab;
    font-size: 12px;
    border: 1px solid #c5cae9;
    cursor: pointer;
}
@media (max-width: 991.98px) {
    .debug-grid {
        grid-template-columns: 1fr;
    }
}
</style>

<div class="d-flex align-items-center justify-content-between flex-wrap gap-2 mb-3">
    <div>
        {% if experiment %}
        <h3 class="mb-1">{{ experiment.title if experiment.title != "Untitled" else experiment.name }} <small class="text-muted">({{ experiment.id }})</small></h3>
        {% else %}
        <h3 class="mb-1">Debug Z</h3>
        <div class="text-muted small">No experiments available.</div>
        {% endif %}
    </div>
    {% if experiment and step_count %}
    <div class="d-flex align-items-center gap-2">
        <label for="debug-step-slider" class="text-muted small mb-0">Step</label>
        <input type="range" class="form-range" id="debug-step-slider" min="0" max="{{ step_count - 1 }}" step="1" value="{{ step_count - 1 }}">
        <span class="text-muted small debug-step-label" id="debug-step-label">{{ steps[-1] }}</span>
    </div>
    {% endif %}
</div>

{% if not experiment %}
<div class="text-muted fst-italic">No experiments found.</div>
{% else %}
{% if figure %}
<div class="debug-loss-wrapper mb-3" id="debug-loss-wrapper">
    <button
        type="button"
        class="debug-pin-btn"
        id="debug-loss-pin"
        aria-pressed="false"
        aria-label="Pin debug plot"
        title="Pin debug plot"
    >
        <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="currentColor" viewBox="0 0 16 16">
            <path d="M4.146.146A.5.5 0 0 1 4.5 0h7a.5.5 0 0 1 .5.5c0 .68-.342 1.174-.646 1.479-.126.125-.25.224-.354.298v4.431l.078.048c.203.127.476.314.751.555C12.36 7.775 13 8.527 13 9.5a.5.5 0 0 1-.5.5h-4v4.5c0 .276-.224 1.5-.5 1.5s-.5-1.224-.5-1.5V10h-4a.5.5 0 0 1-.5-.5c0-.973.64-1.725 1.17-2.189A6 6 0 0 1 5 6.708V2.277a3 3 0 0 1-.354-.298C4.342 1.674 4 1.179 4 .5a.5.5 0 0 1 .146-.354"/>
        </svg>
    </button>
    <div id="debug-loss-plot" class="debug-loss-plot"></div>
</div>
{% endif %}
<div class="debug-grid mb-3">
    <div class="card debug-card h-100">
        <div class="card-header py-2 d-flex justify-content-between align-items-center">
            <span>Input batch + recon + deltas</span>
            <div class="d-flex align-items-center gap-2">
                <span class="text-muted small">Step: <span class="debug-step-label">—</span></span>
                <span class="debug-info-icon" data-bs-toggle="tooltip" data-bs-placement="left" title="Input frames with action labels, recon row, and delta target/recon rows. Read: sharp recon + meaningful deltas; watch for collapse or smeared deltas.">i</span>
            </div>
        </div>
        <div class="card-body">
            <img id="debug-inputs-img" class="d-none" alt="Input batch visualization">
            <div class="text-muted small" id="debug-inputs-caption"></div>
        </div>
    </div>
    <div class="card debug-card h-100">
        <div class="card-header py-2 d-flex justify-content-between align-items-center">
            <span>Temporal pairs</span>
            <div class="d-flex align-items-center gap-2">
                <span class="text-muted small">Step: <span class="debug-step-label">—</span></span>
                <span class="debug-info-icon" data-bs-toggle="tooltip" data-bs-placement="left" title="Sampled (t, t+Δ) pairs. Read: pairs should be semantically consistent; check for augmentation leaks or mismatched pairs.">i</span>
            </div>
        </div>
        <div class="card-body">
            <img id="debug-pairs-img" class="d-none" alt="Temporal pair visualization">
            <div class="text-muted small" id="debug-pairs-caption"></div>
        </div>
    </div>
    <div class="card debug-card h-100">
        <div class="card-header py-2 d-flex justify-content-between align-items-center">
            <span>PCA z</span>
            <div class="d-flex align-items-center gap-2">
                <span class="text-muted small">Step: <span class="debug-step-label">—</span></span>
                <span class="debug-info-icon" data-bs-toggle="tooltip" data-bs-placement="left" title="PCA projection of z embeddings. Read: smooth structure without mode collapse; clusters should reflect visual similarity.">i</span>
            </div>
        </div>
        <div class="card-body">
            <img id="debug-pca-z-img" class="d-none" alt="PCA z">
            <div class="text-muted small" id="debug-pca-z-caption"></div>
        </div>
    </div>
    <div class="card debug-card h-100">
        <div class="card-header py-2 d-flex justify-content-between align-items-center">
            <span>Delta-z PCA</span>
            <div class="d-flex align-items-center gap-2">
                <span class="text-muted small">Step: <span class="debug-step-label">—</span></span>
                <span class="debug-info-icon" data-bs-toggle="tooltip" data-bs-placement="left" title="PCA of Δz across the batch. Read: separated spokes for distinct actions; heavy overlap suggests noisy or entangled dynamics.">i</span>
            </div>
        </div>
        <div class="card-body">
            <img id="debug-delta-z-img" class="d-none" alt="Delta-z PCA">
            <div class="text-muted small" id="debug-delta-z-caption"></div>
        </div>
    </div>
    <div class="card debug-card h-100">
        <div class="card-header py-2 d-flex justify-content-between align-items-center">
            <span>Action alignment (Z)</span>
            <div class="d-flex align-items-center gap-2">
                <span class="text-muted small">Step: <span class="debug-step-label">—</span></span>
                <span class="debug-info-icon" data-bs-toggle="tooltip" data-bs-placement="left" title="Per-action cosine alignment of Δz. Read: higher means consistent action effects; low or negative indicates noisy deltas.">i</span>
            </div>
        </div>
        <div class="card-body">
            <img id="debug-align-z-img" class="d-none" alt="Action alignment Z">
            <div class="text-muted small" id="debug-align-z-caption"></div>
        </div>
    </div>
    <div class="card debug-card h-100">
        <div class="card-header py-2 d-flex justify-content-between align-items-center">
            <span>Cycle error (Z)</span>
            <div class="d-flex align-items-center gap-2">
                <span class="text-muted small">Step: <span class="debug-step-label">—</span></span>
                <span class="debug-info-icon" data-bs-toggle="tooltip" data-bs-placement="left" title="Forward-backward cycle error in z. Read: lower is better; high tails indicate inconsistency across action cycles.">i</span>
            </div>
        </div>
        <div class="card-body">
            <img id="debug-cycle-z-img" class="d-none" alt="Cycle error Z">
            <div class="text-muted small" id="debug-cycle-z-caption"></div>
        </div>
    </div>
    <div class="card debug-card h-100">
        <div class="card-header py-2 d-flex justify-content-between align-items-center">
            <span>Self-distance (Z)</span>
            <div class="d-flex align-items-center gap-2">
                <span class="text-muted small">Step: <span class="debug-step-label">—</span></span>
                <span class="debug-info-icon" data-bs-toggle="tooltip" data-bs-placement="left" title="Self-distance histograms for z. Read: stable distance scale; heavy drift suggests representation collapse or instability.">i</span>
            </div>
        </div>
        <div class="card-body">
            <img id="debug-self-z-img" class="d-none" alt="Self-distance Z">
            <div class="text-muted small" id="debug-self-z-caption"></div>
        </div>
    </div>
    <div class="card debug-card h-100">
        <div class="card-header py-2 d-flex justify-content-between align-items-center">
            <span>Smoothness (Z)</span>
            <div class="d-flex align-items-center gap-2">
                <span class="text-muted small">Step: <span class="debug-step-label">—</span></span>
                <span class="debug-info-icon" data-bs-toggle="tooltip" data-bs-placement="left" title="kNN distance raincloud + spectrum for z. Read: low, tight distances with stable spectrum.">i</span>
            </div>
        </div>
        <div class="card-body">
            <img id="debug-smooth-z-img" class="d-none" alt="Smoothness Z">
            <div class="text-muted small" id="debug-smooth-z-caption"></div>
        </div>
    </div>
    <div class="card debug-card h-100">
        <div class="card-header py-2 d-flex justify-content-between align-items-center">
            <span>Two-step composition error (Z)</span>
            <div class="d-flex align-items-center gap-2">
                <span class="text-muted small">Step: <span class="debug-step-label">—</span></span>
                <span class="debug-info-icon" data-bs-toggle="tooltip" data-bs-placement="left" title="Error between observed 2-step Δz and composed action deltas. Read: lower mean and tight spread is better composability.">i</span>
            </div>
        </div>
        <div class="card-body">
            <img id="debug-comp-z-img" class="d-none" alt="Composition error Z">
            <div class="text-muted small" id="debug-comp-z-caption"></div>
        </div>
    </div>
    <div class="card debug-card h-100">
        <div class="card-header py-2 d-flex justify-content-between align-items-center">
            <span>Neighborhood stability (Z)</span>
            <div class="d-flex align-items-center gap-2">
                <span class="text-muted small">Step: <span class="debug-step-label">—</span></span>
                <span class="debug-info-icon" data-bs-toggle="tooltip" data-bs-placement="left" title="Jaccard overlap of kNN sets over time. Read: higher is more stable; low values imply drift.">i</span>
            </div>
        </div>
        <div class="card-body">
            <img id="debug-stability-z-img" class="d-none" alt="Stability Z">
            <div class="text-muted small" id="debug-stability-z-caption"></div>
        </div>
    </div>
    <div class="card debug-card h-100">
        <div class="card-header py-2 d-flex justify-content-between align-items-center">
            <span>Variance spectrum (Δz)</span>
            <div class="d-flex align-items-center gap-2">
                <span class="text-muted small">Step: <span class="debug-step-label">—</span></span>
                <span class="debug-info-icon" data-bs-toggle="tooltip" data-bs-placement="left" title="Eigenvalue spectrum of Δz covariance. Read: avoid extreme spikes or collapse; spectrum should be stable across steps.">i</span>
            </div>
        </div>
        <div class="card-body">
            <img id="debug-spectrum-z-img" class="d-none" alt="Variance spectrum Z">
            <div class="text-muted small" id="debug-spectrum-z-caption"></div>
        </div>
    </div>
    <div class="card debug-card h-100">
        <div class="card-header py-2 d-flex justify-content-between align-items-center">
            <span>Hard samples</span>
            <div class="d-flex align-items-center gap-2">
                <span class="text-muted small">Step: <span class="debug-step-label">—</span></span>
                <span class="debug-info-icon" data-bs-toggle="tooltip" data-bs-placement="left" title="Top reconstruction errors or hardest examples. Read: identify failure cases and drift in difficult regions.">i</span>
            </div>
        </div>
        <div class="card-body">
            <img id="debug-hard-img" class="d-none" alt="Hard samples">
            <div class="text-muted small" id="debug-hard-caption"></div>
        </div>
    </div>
</div>
{% endif %}
{% endblock %}

{% block extra_scripts %}
{% if experiment and step_count %}
<script>
document.addEventListener("DOMContentLoaded", () => {
    const steps = {{ steps | tojson }};
    const debugMap = {{ debug_map | tojson }};
    const slider = document.getElementById("debug-step-slider");
    const stepLabels = document.querySelectorAll(".debug-step-label");
    const lossPlot = document.getElementById("debug-loss-plot");
    const lossWrapper = document.getElementById("debug-loss-wrapper");
    const lossPinButton = document.getElementById("debug-loss-pin");
    const figure = {{ figure | tojson if figure else 'null' }};
    let lossPinned = false;
    const targets = [
        { keys: ["inputs"], img: "debug-inputs-img", caption: "debug-inputs-caption" },
        { keys: ["pairs"], img: "debug-pairs-img", caption: "debug-pairs-caption" },
        { keys: ["pca_z"], img: "debug-pca-z-img", caption: "debug-pca-z-caption" },
        { keys: ["delta_z_pca"], img: "debug-delta-z-img", caption: "debug-delta-z-caption" },
        { keys: ["action_alignment_detail", "alignment_z"], img: "debug-align-z-img", caption: "debug-align-z-caption" },
        { keys: ["cycle_error"], img: "debug-cycle-z-img", caption: "debug-cycle-z-caption" },
        { keys: ["self_distance"], img: "debug-self-z-img", caption: "debug-self-z-caption" },
        { keys: ["smoothness_z"], img: "debug-smooth-z-img", caption: "debug-smooth-z-caption" },
        { keys: ["composition_z"], img: "debug-comp-z-img", caption: "debug-comp-z-caption" },
        { keys: ["stability_z"], img: "debug-stability-z-img", caption: "debug-stability-z-caption" },
        { keys: ["variance_spectrum"], img: "debug-spectrum-z-img", caption: "debug-spectrum-z-caption" },
        { keys: ["samples_hard"], img: "debug-hard-img", caption: "debug-hard-caption" },
    ];

    function resolveUrl(keys, step) {
        for (const key of keys) {
            const perStep = debugMap[key] || {};
            const url = perStep[step] || perStep[String(step)];
            if (url) {
                return { url, key };
            }
        }
        return { url: null, key: keys[0] };
    }

    function updateImages(step) {
        targets.forEach((target) => {
            const img = document.getElementById(target.img);
            const caption = document.getElementById(target.caption);
            if (!img || !caption) return;
            const result = resolveUrl(target.keys, step);
            if (result.url) {
                img.src = result.url;
                img.classList.remove("d-none");
                caption.textContent = "";
            } else {
                img.classList.add("d-none");
                caption.textContent = `No image for step ${step}`;
            }
        });
    }

    function nearestStepAtOrBelow(target) {
        if (!steps.length) return null;
        let best = null;
        for (let i = 0; i < steps.length; i++) {
            const step = steps[i];
            if (step > target) {
                continue;
            }
            if (best === null || step > best) {
                best = step;
            }
        }
        return best;
    }

    function updateFromStep(stepValue) {
        const nearest = nearestStepAtOrBelow(stepValue);
        const step = nearest !== null ? nearest : steps[steps.length - 1];
        stepLabels.forEach((label) => {
            label.textContent = step ?? "—";
        });
        if (slider) {
            const idx = steps.indexOf(step);
            if (idx >= 0) {
                slider.value = idx;
            }
        }
        updateImages(step);
    }

    function updateFromIndex(idx) {
        const index = Math.max(0, Math.min(idx, steps.length - 1));
        const step = steps[index];
        stepLabels.forEach((label) => {
            label.textContent = step ?? "—";
        });
        updateImages(step);
    }

    function setLossPinned(pinned) {
        lossPinned = pinned;
        if (!lossWrapper || !lossPinButton) return;
        lossWrapper.classList.toggle("sticky-active", pinned);
        lossPinButton.classList.toggle("active", pinned);
        lossPinButton.setAttribute("aria-pressed", pinned ? "true" : "false");
        lossPinButton.setAttribute("title", pinned ? "Unpin debug plot" : "Pin debug plot");
    }

    function renderLossPlot() {
        if (!lossPlot || !figure || typeof Plotly === "undefined") return;
        const layout = {
            ...figure.layout,
            height: 220,
            margin: { ...(figure.layout?.margin || {}), t: 30, b: 50, l: 50, r: 10 },
        };
        Plotly.react(lossPlot, figure.data, layout, buildPlotlyConfig(figure.config || {})).then(() => {
            lossPlot.on("plotly_hover", (event) => {
                const point = event?.points?.[0];
                if (!point || typeof point.x === "undefined") return;
                updateFromStep(point.x);
            });
            lossPlot.on("plotly_unhover", () => {
                if (!lossPinned) {
                    updateFromStep(steps[steps.length - 1]);
                }
            });
        });
    }

    if (slider) {
        slider.addEventListener("input", () => {
            updateFromIndex(Number(slider.value || 0));
        });
    }

    if (lossPinButton && lossWrapper) {
        lossPinButton.addEventListener("click", () => {
            setLossPinned(!lossPinned);
        });
    }

    setLossPinned(true);
    renderLossPlot();
    updateFromIndex(steps.length - 1);
    const tooltipTriggerList = Array.from(document.querySelectorAll('[data-bs-toggle="tooltip"]'));
    tooltipTriggerList.forEach((el) => {
        if (window.bootstrap) {
            new bootstrap.Tooltip(el);
        }
    });
});
</script>
{% endif %}
{% endblock %}
