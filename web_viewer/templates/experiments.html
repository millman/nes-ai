{% extends "base.html" %}

{% block extra_head %}
<script defer src="{{ url_for('static', filename='grid.js') }}"></script>
{% endblock %}

{% block body %}
{% if experiments %}
<div class="table-responsive">
    <table class="table align-top exp-table">
        <thead class="table-light">
        <tr>
            <th data-col-id="notes">Notes</th>
            <th data-col-id="name">Experiment</th>
            <th data-col-id="metadata">metadata.txt</th>
            <th data-col-id="image">metrics/loss_curves.png</th>
        </tr>
        </thead>
        <tbody>
        {% for exp in experiments %}
        <tr data-exp-id="{{ exp.id }}">
            <td class="notes-cell" data-col-id="notes">
                <form class="notes-form d-flex flex-column h-100" data-exp-id="{{ exp.id }}">
                    <textarea class="form-control font-monospace flex-grow-1 mb-2" placeholder="Add experiment notes..." rows="6">{{- exp.notes_text -}}</textarea>
                    <div class="d-flex align-items-center gap-2">
                        <button type="button" class="btn btn-primary btn-sm save-notes">Save</button>
                        <span class="notes-status small text-muted" aria-live="polite"></span>
                    </div>
                </form>
            </td>
            <td data-col-id="name" class="experiment-cell">
                <form class="title-form" data-exp-id="{{ exp.id }}">
                    {% set title_value = "" if exp.title == "Untitled" else exp.title %}
                    <div class="input-group input-group-sm title-input-group">
                        <input
                            type="text"
                            class="form-control form-control-sm exp-title-input"
                            value="{{ title_value }}"
                            placeholder="Untitled"
                            aria-label="Experiment title"
                            readonly
                        >
                    </div>
                    <span class="title-status small text-muted" aria-live="polite"></span>
                </form>
                <div class="fw-semibold">{{ exp.name }}</div>
                <div class="font-monospace text-muted small mt-1">{{ exp.git_commit }}</div>
            </td>
            <td data-col-id="metadata">
                <div class="metadata-wrapper card card-body p-2" data-exp-id="{{ exp.id }}">
                    <pre class="metadata-block">{{ exp.metadata_text }}</pre>
                </div>
                <button type="button" class="btn btn-sm btn-outline-secondary mt-2 metadata-toggle" data-target="{{ exp.id }}">Expand</button>
            </td>
            <td class="image-cell" data-col-id="image">
                {% if exp.loss_image %}
                <a href="{{ url_for('experiment_detail', exp_id=exp.id) }}" class="d-block h-100">
                    <img src="{{ url_for('serve_asset', relative_path=exp.id ~ '/metrics/loss_curves.png') }}" alt="Loss curves for {{ exp.name }}" class="img-fluid rounded border h-100 w-100 object-fit-contain">
                </a>
                {% else %}
                <div class="text-muted fst-italic">metrics/loss_curves.png missing</div>
                {% endif %}
            </td>
        </tr>
        {% endfor %}
        </tbody>
    </table>
</div>
{% else %}
<div class="alert alert-info">No experiments found in {{ cfg.output_dir }}.</div>
{% endif %}
{% endblock %}
