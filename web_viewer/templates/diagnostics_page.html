{% extends "base.html" %}

{% block body %}
<div class="d-flex align-items-center justify-content-between flex-wrap gap-2 mb-3">
    <div>
        {% if experiment %}
        <h3 class="mb-1">Diagnostics <small class="text-muted">({{ experiment.title if experiment.title != "Untitled" else "Untitled" }} · {{ experiment.name }})</small></h3>
        {% else %}
        <h3 class="mb-1">Diagnostics</h3>
        <div class="text-muted small">No experiments with diagnostics outputs.</div>
        {% endif %}
    </div>
    {% if experiment %}
    <div class="d-flex align-items-center gap-2 flex-wrap">
        <a class="btn btn-outline-secondary btn-sm" href="{{ url_for('experiment_detail', exp_id=experiment.id) }}">Open experiment</a>
    </div>
    {% endif %}
</div>

{% if not experiment %}
<div class="text-muted fst-italic">No diagnostics images found in any experiments.</div>
{% else %}
<div class="small text-muted mb-2">
    Saved PNGs in vis_delta_z_pca, vis_action_alignment, vis_cycle_error.
    <span class="ms-2">Experiment ID: <span class="font-monospace">{{ experiment.id }}</span></span>
</div>

{% if experiment.diagnostics_steps %}
<div class="card mb-3">
    <div class="card-body">
        <label for="diagnostics-step" class="form-label mb-1">Select visualization step</label>
        <input type="range" class="form-range" id="diagnostics-step" min="0" max="{{ experiment.diagnostics_steps|length - 1 }}" step="1" value="{{ experiment.diagnostics_steps|length - 1 }}">
        <div class="d-flex justify-content-between align-items-center small text-muted">
            <span>Earliest: {{ experiment.diagnostics_steps[0] }}</span>
            <span>Current step: <span class="fw-semibold" id="diagnostics-step-label">{{ experiment.diagnostics_steps[-1] }}</span></span>
            <span>Latest: {{ experiment.diagnostics_steps[-1] }}</span>
        </div>
    </div>
</div>
<div class="row g-3">
    <div class="col-12 col-lg-4">
        <div class="card h-100">
            <div class="card-header py-2">Delta-z PCA</div>
            <div class="card-body d-flex flex-column gap-2">
                <img id="diagnostics-delta-img" class="img-fluid rounded border d-none" alt="Delta-z PCA diagnostic">
                <div class="text-muted small" id="diagnostics-delta-caption"></div>
            </div>
        </div>
    </div>
    <div class="col-12 col-lg-4">
        <div class="card h-100">
            <div class="card-header py-2">Cosine alignment</div>
            <div class="card-body d-flex flex-column gap-2">
                <img id="diagnostics-alignment-img" class="img-fluid rounded border d-none" alt="Cosine alignment diagnostic">
                <div class="text-muted small" id="diagnostics-alignment-caption"></div>
            </div>
        </div>
    </div>
    <div class="col-12 col-lg-4">
        <div class="card h-100">
            <div class="card-header py-2">Cycle error</div>
            <div class="card-body d-flex flex-column gap-2">
                <img id="diagnostics-cycle-img" class="img-fluid rounded border d-none" alt="Cycle error diagnostic">
                <div class="text-muted small" id="diagnostics-cycle-caption"></div>
            </div>
        </div>
    </div>
</div>
<div class="card mt-3">
    <div class="card-header py-2">CSV outputs</div>
    <div class="card-body">
        <ul class="mb-0 small" id="diagnostics-csv-list"></ul>
    </div>
</div>
<div class="card mt-3">
    <div class="card-header py-2">Diagnostic frames</div>
    <div class="card-body">
        <div class="mb-2">
            <label for="diagnostics-frame" class="form-label mb-1">Select frame</label>
            <input type="range" class="form-range" id="diagnostics-frame" min="0" max="0" step="1" value="0" disabled>
            <div class="small text-muted d-flex justify-content-between">
                <span>Count: <span id="diagnostics-frame-count">0</span></span>
                <span id="diagnostics-frame-label">No frame selected</span>
            </div>
        </div>
        <img id="diagnostics-frame-img" class="rounded border d-none" alt="Diagnostic frame preview">
    </div>
</div>
{% else %}
<div class="text-muted fst-italic">Diagnostics PNGs not found for this experiment.</div>
{% endif %}
{% endif %}
{% endblock %}

{% block extra_scripts %}
{% if experiment and experiment.diagnostics_steps %}
<script>
document.addEventListener("DOMContentLoaded", () => {
    const steps = {{ experiment.diagnostics_steps | tojson }};
    const diagnostics = {{ diagnostics_map | tojson }};
    const diagnosticsCsv = {{ diagnostics_csv_map | tojson }};
    const frameMap = {{ frame_map | tojson }};
    const slider = document.getElementById("diagnostics-step");
    const stepLabel = document.getElementById("diagnostics-step-label");
    const targets = {
        delta_z_pca: {
            img: document.getElementById("diagnostics-delta-img"),
            caption: document.getElementById("diagnostics-delta-caption"),
            label: "vis_delta_z_pca",
        },
        action_alignment: {
            img: document.getElementById("diagnostics-alignment-img"),
            caption: document.getElementById("diagnostics-alignment-caption"),
            label: "vis_action_alignment",
        },
        cycle_error: {
            img: document.getElementById("diagnostics-cycle-img"),
            caption: document.getElementById("diagnostics-cycle-caption"),
            label: "vis_cycle_error",
        },
    };
    const csvList = document.getElementById("diagnostics-csv-list");
    const frameSlider = document.getElementById("diagnostics-frame");
    const frameCount = document.getElementById("diagnostics-frame-count");
    const frameLabel = document.getElementById("diagnostics-frame-label");
    const frameImg = document.getElementById("diagnostics-frame-img");
    let currentFrameUrls = [];

    function resolveUrl(diagKey, step) {
        const perDiag = diagnostics[diagKey] || {};
        return perDiag[step] || perDiag[String(step)] || null;
    }

    function resolveCsvUrl(diagKey, step) {
        const perDiag = diagnosticsCsv[diagKey] || {};
        return perDiag[step] || perDiag[String(step)] || null;
    }

    function populateCsvLinks(step) {
        if (!csvList) return;
        csvList.innerHTML = "";
        const diagKeys = Object.keys(diagnosticsCsv);
        if (!diagKeys.length) {
            const li = document.createElement("li");
            li.textContent = "No CSVs found for this experiment.";
            csvList.appendChild(li);
            return;
        }
        diagKeys.forEach((key) => {
            const li = document.createElement("li");
            const pretty = key.replace(/_/g, " ");
            const url = resolveCsvUrl(key, step);
            const strong = document.createElement("strong");
            strong.textContent = pretty + ": ";
            li.appendChild(strong);
            if (url) {
                const a = document.createElement("a");
                a.href = url;
                a.textContent = `step ${step}`;
                a.target = "_blank";
                li.appendChild(a);
            } else {
                li.append("no CSV for this step");
            }
            csvList.appendChild(li);
        });
    }

    function updateFrameForIndex(idx) {
        if (!frameImg || !frameLabel || !currentFrameUrls.length) return;
        const clamped = Math.min(Math.max(idx, 0), currentFrameUrls.length - 1);
        frameImg.src = currentFrameUrls[clamped];
        frameImg.classList.remove("d-none");
        frameLabel.textContent = `Frame ${clamped + 1} / ${currentFrameUrls.length}`;
    }

    function updateFrameSlider(step) {
        if (!frameSlider || !frameCount || !frameLabel || !frameImg) return;
        const urls = frameMap[step] || frameMap[String(step)] || [];
        currentFrameUrls = urls;
        if (!urls.length) {
            frameSlider.disabled = true;
            frameSlider.max = 0;
            frameSlider.value = 0;
            frameCount.textContent = "0";
            frameLabel.textContent = "No frames for this step";
            frameImg.classList.add("d-none");
            return;
        }
        frameSlider.disabled = false;
        frameSlider.max = urls.length - 1;
        const newVal = Math.min(Number(frameSlider.value || 0), urls.length - 1);
        frameSlider.value = newVal;
        frameCount.textContent = String(urls.length);
        updateFrameForIndex(newVal);
    }

    function updateForStep(index) {
        const safeIndex = Math.min(Math.max(index, 0), steps.length - 1);
        const step = steps[safeIndex];
        if (stepLabel) stepLabel.textContent = step ?? "—";
        Object.entries(targets).forEach(([key, refs]) => {
            if (!refs.img || !refs.caption) return;
            const url = resolveUrl(key, step);
            if (url) {
                refs.img.src = url;
                refs.img.classList.remove("d-none");
                refs.caption.textContent = `${refs.label} @ step ${step}`;
            } else {
                refs.img.classList.add("d-none");
                refs.caption.textContent = `No image for step ${step} in ${refs.label}`;
            }
        });
        populateCsvLinks(step);
        updateFrameSlider(step);
    }

    if (slider) {
        slider.addEventListener("input", (ev) => {
            updateForStep(Number(ev.target.value));
        });
        updateForStep(Number(slider.value || (steps.length - 1)));
    }

    if (frameSlider) {
        frameSlider.addEventListener("input", (ev) => {
            updateFrameForIndex(Number(ev.target.value));
        });
    }
});
</script>
{% endif %}
{% endblock %}
