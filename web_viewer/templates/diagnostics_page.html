{% extends "base.html" %}

{% set frame_steps = frame_map.keys()|list|sort if frame_map is defined else [] %}
{% set steps = diagnostic_steps if diagnostic_steps is defined else (experiment.diagnostics_z_steps if experiment and experiment.diagnostics_z_steps else frame_steps) %}
{% set step_count = steps|length %}
{% set view_label = view_label if view_label is defined else "" %}

{% block extra_head %}
<link rel="stylesheet" href="{{ url_for('static', filename='common_styles.css') }}">
<script src="https://cdn.plot.ly/plotly-2.27.0.min.js"></script>
<script src="{{ url_for('static', filename='plotly_utils.js') }}"></script>
<script defer src="{{ url_for('static', filename='diagnostics_common.js') }}"></script>
{% endblock %}

{% block body %}
<div class="d-flex align-items-center justify-content-between flex-wrap gap-2 mb-3">
    <div class="d-flex align-items-center gap-2 flex-wrap">
        {% if experiment %}
        <h3 class="mb-1">{{ experiment.title if experiment.title != "Untitled" else "Untitled" }} <small class="text-muted">({{ experiment.id }})</small></h3>
        {% else %}
        <h3 class="mb-1">{{ page_title if page_title is defined else "Diagnostics" }}</h3>
        <div class="text-muted small">{{ no_experiment_message if no_experiment_message is defined else "No experiments with diagnostics outputs." }}</div>
        {% endif %}
    </div>
    {% if experiment %}
    <div class="d-flex align-items-center gap-2 flex-wrap">
        <button
            class="btn btn-sm btn-outline-secondary"
            type="button"
            id="diagnostics-toggle-btn"
            data-bs-toggle="collapse"
            data-bs-target="#diagnostics-top-grid"
            aria-expanded="true"
            aria-controls="diagnostics-top-grid"
        >
            Collapse Delta/Alignment
        </button>
    </div>
    {% endif %}
</div>

{% if not experiment %}
<div class="text-muted fst-italic">No diagnostics images found in any experiments.</div>
{% else %}

{% if step_count %}
<div class="diagnostic-status-strip mb-3" id="diagnostics-status-strip">
    <div class="diagnostic-status-item">
        <div class="diagnostic-status-label">||z|| mean</div>
        <div class="diagnostic-status-value" data-status-metric="z_norm_mean">—</div>
    </div>
    <div class="diagnostic-status-item">
        <div class="diagnostic-status-label">||z|| p95</div>
        <div class="diagnostic-status-value" data-status-metric="z_norm_p95">—</div>
    </div>
    <div class="diagnostic-status-item">
        <div class="diagnostic-status-label">||h|| mean</div>
        <div class="diagnostic-status-value" data-status-metric="h_norm_mean">—</div>
    </div>
    <div class="diagnostic-status-item">
        <div class="diagnostic-status-label">||h|| p95</div>
        <div class="diagnostic-status-value" data-status-metric="h_norm_p95">—</div>
    </div>
    <div class="diagnostic-status-item">
        <div class="diagnostic-status-label">||p|| mean</div>
        <div class="diagnostic-status-value" data-status-metric="p_norm_mean">—</div>
    </div>
    <div class="diagnostic-status-item">
        <div class="diagnostic-status-label">||p|| p95</div>
        <div class="diagnostic-status-value" data-status-metric="p_norm_p95">—</div>
    </div>
    <div class="diagnostic-status-item">
        <div class="diagnostic-status-label">H drift</div>
        <div class="diagnostic-status-value" data-status-metric="h_drift_mean">—</div>
    </div>
    <div class="diagnostic-status-item">
        <div class="diagnostic-status-label">P drift</div>
        <div class="diagnostic-status-value" data-status-metric="p_drift_mean">—</div>
    </div>
    <div class="diagnostic-status-item">
        <div class="diagnostic-status-label">ID acc (P)</div>
        <div class="diagnostic-status-value" data-status-metric="id_acc_p">—</div>
    </div>
</div>
<div class="plot-pin-wrapper mb-3" id="diagnostics-loss-wrapper">
    <button
        type="button"
        class="plot-pin-btn"
        id="diagnostics-loss-pin"
        aria-pressed="false"
        aria-label="Pin diagnostics plot"
        title="Pin diagnostics plot"
    >
        <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="currentColor" viewBox="0 0 16 16">
            <path d="M4.146.146A.5.5 0 0 1 4.5 0h7a.5.5 0 0 1 .5.5c0 .68-.342 1.174-.646 1.479-.126.125-.25.224-.354.298v4.431l.078.048c.203.127.476.314.751.555C12.36 7.775 13 8.527 13 9.5a.5.5 0 0 1-.5.5h-4v4.5c0 .276-.224 1.5-.5 1.5s-.5-1.224-.5-1.5V10h-4a.5.5 0 0 1-.5-.5c0-.973.64-1.725 1.17-2.189A6 6 0 0 1 5 6.708V2.277a3 3 0 0 1-.354-.298C4.342 1.674 4 1.179 4 .5a.5.5 0 0 1 .146-.354"/>
        </svg>
    </button>
    <div id="diagnostics-loss-plot" class="diagnostics-loss-plot"></div>
</div>
<div id="diagnostics-top-grid" class="collapse show">
    <div class="diagnostic-grid-top mb-3">
        <div class="card h-100 diag-delta">
            <div class="card-header py-2 d-flex justify-content-between align-items-center" id="diagnostics-delta-header">
                <span class="image-preview-card-title">Delta-{{ view_label }} PCA</span>
                <div class="d-flex align-items-center gap-2">
                    <span class="text-muted small">Step: <span class="step-label-value">—</span></span>
                    <span
                        class="diagnostic-info-icon"
                        data-bs-toggle="tooltip"
                        data-bs-placement="left"
                        title="PCA of delta-{{ view_label }} steps across the batch. Read: spokes or clusters correspond to action directions; separation shows distinct motions. Good: clear, separated clusters with minimal overlap."
                    >i</span>
                </div>
            </div>
            <div class="card-body d-flex flex-column gap-2">
                <img id="diagnostics-delta-img" class="img-fluid rounded border d-none" alt="Delta-{{ view_label }} PCA diagnostic">
                <div class="text-muted small" id="diagnostics-delta-caption"></div>
            </div>
        </div>
        <div class="card h-100 diag-align-detail">
            <div class="card-header py-2 d-flex justify-content-between align-items-center" id="diagnostics-alignment-detail-header">
                <span class="image-preview-card-title">Action alignment</span>
                <div class="d-flex align-items-center gap-2">
                    <span class="text-muted small">Step: <span class="step-label-value">—</span></span>
                    <span
                        class="diagnostic-info-icon"
                        data-bs-toggle="tooltip"
                        data-bs-placement="left"
                        title="Per-action cosine alignment of delta-{{ view_label }} directions. Read: values near 1 mean consistent action effects; near 0 means noisy alignment. Good: high alignment for common actions with few negative outliers."
                    >i</span>
                </div>
            </div>
            <div class="card-body d-flex flex-column gap-2">
                <img id="diagnostics-alignment-detail-img" class="img-fluid rounded border d-none" alt="Alignment detail diagnostic">
                <div class="text-muted small" id="diagnostics-alignment-detail-caption"></div>
            </div>
        </div>
    </div>
</div>
<div class="diagnostic-grid-bottom mb-3">
    <div class="card h-100 diag-self-distance">
        <div class="card-header py-2 d-flex justify-content-between align-items-center" id="diagnostics-self-distance-header">
            <span class="image-preview-card-title">Self-distance ({{ view_label|upper }})</span>
            <span class="text-muted small">Step: <span class="step-label-value">—</span></span>
        </div>
        <div class="card-body d-flex flex-column gap-2">
            <img id="diagnostics-self-distance-img" class="img-fluid rounded border d-none" alt="Self-distance diagnostic">
            <div class="text-muted small" id="diagnostics-self-distance-caption"></div>
        </div>
    </div>
    <div class="card h-100 diag-cycle">
        <div class="card-header py-2 d-flex justify-content-between align-items-center" id="diagnostics-cycle-header">
            <span class="image-preview-card-title">Cycle error ({{ view_label|upper }})</span>
            <span class="text-muted small">Step: <span class="step-label-value">—</span></span>
        </div>
        <div class="card-body d-flex flex-column gap-2">
            <img id="diagnostics-cycle-img" class="img-fluid rounded border d-none" alt="Cycle error diagnostic">
            <div class="text-muted small" id="diagnostics-cycle-caption"></div>
        </div>
    </div>
</div>
{% if view_label == "z" %}
<div class="diagnostic-grid-extra mb-3">
    <div class="card h-100">
        <div class="card-header py-2 d-flex justify-content-between align-items-center" id="diagnostics-rollout-header">
            <span class="image-preview-card-title">Rollout divergence</span>
            <div class="d-flex align-items-center gap-2">
                <span class="text-muted small">Step: <span class="step-label-value">—</span></span>
                <span class="diagnostic-info-icon" data-bs-toggle="tooltip" data-bs-placement="left" title="Pixel vs latent error over rollout horizon. Read: growing curves show compounding drift; flat latent with rising pixel points to decoder issues.">i</span>
            </div>
        </div>
        <div class="card-body d-flex flex-column gap-2">
            <img id="diagnostics-rollout-img" class="img-fluid rounded border d-none" alt="Rollout divergence">
            <div class="text-muted small" id="diagnostics-rollout-caption"></div>
        </div>
    </div>
    <div class="card h-100">
        <div class="card-header py-2 d-flex justify-content-between align-items-center" id="diagnostics-consistency-header">
            <span class="image-preview-card-title">Z consistency</span>
            <div class="d-flex align-items-center gap-2">
                <span class="text-muted small">Step: <span class="step-label-value">—</span></span>
                <span class="diagnostic-info-icon" data-bs-toggle="tooltip" data-bs-placement="left" title="Repeat-encode same frame with small noise. Read: tight histograms imply stable z; wide spread predicts flicker.">i</span>
            </div>
        </div>
        <div class="card-body d-flex flex-column gap-2">
            <img id="diagnostics-consistency-img" class="img-fluid rounded border d-none" alt="Z consistency">
            <div class="text-muted small" id="diagnostics-consistency-caption"></div>
        </div>
    </div>
    <div class="card h-100">
        <div class="card-header py-2 d-flex justify-content-between align-items-center" id="diagnostics-monotonicity-header">
            <span class="image-preview-card-title">Z monotonicity</span>
            <div class="d-flex align-items-center gap-2">
                <span class="text-muted small">Step: <span class="step-label-value">—</span></span>
                <span class="diagnostic-info-icon" data-bs-toggle="tooltip" data-bs-placement="left" title="Z distance vs pixel shift. Read: smooth monotonic curve indicates perceptual alignment.">i</span>
            </div>
        </div>
        <div class="card-body d-flex flex-column gap-2">
            <img id="diagnostics-monotonicity-img" class="img-fluid rounded border d-none" alt="Z monotonicity">
            <div class="text-muted small" id="diagnostics-monotonicity-caption"></div>
        </div>
    </div>
    <div class="card h-100">
        <div class="card-header py-2 d-flex justify-content-between align-items-center" id="diagnostics-path-header">
            <span class="image-preview-card-title">Path independence</span>
            <div class="d-flex align-items-center gap-2">
                <span class="text-muted small">Step: <span class="step-label-value">—</span></span>
                <span class="diagnostic-info-icon" data-bs-toggle="tooltip" data-bs-placement="left" title="Compare end-state z/p for two action paths with same target. Low bars mean history doesn't leak.">i</span>
            </div>
        </div>
        <div class="card-body d-flex flex-column gap-2">
            <img id="diagnostics-path-img" class="img-fluid rounded border d-none" alt="Path independence">
            <div class="text-muted small" id="diagnostics-path-caption"></div>
        </div>
    </div>
</div>
{% elif view_label == "s" %}
<div class="diagnostic-grid-extra mb-3">
    <div class="card h-100">
        <div class="card-header py-2 d-flex justify-content-between align-items-center" id="diagnostics-straightline-header">
        <span class="image-preview-card-title">Straight-line action rays (P)</span>
            <div class="d-flex align-items-center gap-2">
                <span class="text-muted small">Step: <span class="step-label-value">—</span></span>
                <span class="diagnostic-info-icon" data-bs-toggle="tooltip" data-bs-placement="left" title="Repeated actions in P should trace straight rays; opposite actions should mirror.">i</span>
            </div>
        </div>
        <div class="card-body d-flex flex-column gap-2">
            <img id="diagnostics-straightline-img" class="img-fluid rounded border d-none" alt="Straight-line P">
            <div class="text-muted small" id="diagnostics-straightline-caption"></div>
        </div>
    </div>
</div>
{% elif view_label == "h" %}
<div class="diagnostic-grid-extra mb-3">
    <div class="card h-100">
        <div class="card-header py-2 d-flex justify-content-between align-items-center" id="diagnostics-h-ablation-header">
            <span class="image-preview-card-title">H ablation divergence</span>
            <div class="d-flex align-items-center gap-2">
                <span class="text-muted small">Step: <span class="step-label-value">—</span></span>
                <span class="diagnostic-info-icon" data-bs-toggle="tooltip" data-bs-placement="left" title="Compare rollout errors with normal H vs zeroed H. Big gap means H carries dynamics.">i</span>
            </div>
        </div>
        <div class="card-body d-flex flex-column gap-2">
            <img id="diagnostics-h-ablation-img" class="img-fluid rounded border d-none" alt="H ablation">
            <div class="text-muted small" id="diagnostics-h-ablation-caption"></div>
        </div>
    </div>
    <div class="card h-100">
        <div class="card-header py-2 d-flex justify-content-between align-items-center" id="diagnostics-h-drift-header">
            <span class="image-preview-card-title">H drift by action</span>
            <div class="d-flex align-items-center gap-2">
                <span class="text-muted small">Step: <span class="step-label-value">—</span></span>
                <span class="diagnostic-info-icon" data-bs-toggle="tooltip" data-bs-placement="left" title="Mean ||h_{t+1}-h_t|| grouped by action. Large deltas suggest hidden dynamics leak.">i</span>
            </div>
        </div>
        <div class="card-body d-flex flex-column gap-2">
            <img id="diagnostics-h-drift-img" class="img-fluid rounded border d-none" alt="H drift by action">
            <div class="text-muted small" id="diagnostics-h-drift-caption"></div>
        </div>
    </div>
    <div class="card h-100">
        <div class="card-header py-2 d-flex justify-content-between align-items-center" id="diagnostics-norm-header">
            <span class="image-preview-card-title">Norm stability</span>
            <div class="d-flex align-items-center gap-2">
                <span class="text-muted small">Step: <span class="step-label-value">—</span></span>
                <span class="diagnostic-info-icon" data-bs-toggle="tooltip" data-bs-placement="left" title="Mean/p95 norms for z/h/p/f over steps. Watch for drift or explosion.">i</span>
            </div>
        </div>
        <div class="card-body d-flex flex-column gap-2">
            <img id="diagnostics-norm-img" class="img-fluid rounded border d-none" alt="Norm stability">
            <div class="text-muted small" id="diagnostics-norm-caption"></div>
        </div>
    </div>
</div>
{% endif %}
<div class="card mt-3">
    <div class="card-header py-2">Diagnostic frames</div>
    <div class="card-body">
        <div class="mb-2">
            <label for="diagnostics-frame" class="form-label mb-1">Select frame</label>
            <input type="range" class="form-range" id="diagnostics-frame" min="0" max="0" step="1" value="0" disabled>
            <div class="small text-muted d-flex justify-content-between">
                <span>Count: <span id="diagnostics-frame-count">0</span></span>
                <span id="diagnostics-frame-label">No frame selected</span>
            </div>
        </div>
        <img id="diagnostics-frame-img" class="rounded border d-none diagnostic-frame-img" alt="Diagnostic frame preview">
        <div class="small text-muted" id="diagnostics-frame-action"></div>
        <div class="small text-muted font-monospace mt-1" id="diagnostics-frame-path"></div>
        <div class="small text-muted" id="diagnostics-frame-dimensions"></div>
    </div>
</div>
<div class="card mt-3 d-none" id="diagnostics-summary-wrapper">
    <div class="card-header py-2 d-flex justify-content-between align-items-center">
        <span>Alignment snapshot</span>
        <span class="badge text-bg-light" id="diagnostics-summary-step">Latest</span>
    </div>
    <div class="card-body">
        <div class="small text-muted" id="diagnostics-summary-caption">
            Parsed from the latest action_alignment_report and action_alignment_strength outputs.
        </div>
        <div class="table-responsive mt-2">
            <table class="table table-sm table-striped align-middle mb-0">
                <thead>
                    <tr>
                        <th scope="col">Action</th>
                        <th scope="col">Count</th>
                        <th scope="col">Mean cos</th>
                        <th scope="col">Pct &gt; thr</th>
                        <th scope="col">Δ norm (med)</th>
                        <th scope="col">Δ norm (p90)</th>
                        <th scope="col">Strength</th>
                        <th scope="col">Notes</th>
                    </tr>
                </thead>
                <tbody id="diagnostics-summary-body">
                    <tr class="text-muted">
                        <td colspan="8">No alignment summary available.</td>
                    </tr>
                </tbody>
            </table>
        </div>
        <div class="small text-muted mt-1" id="diagnostics-summary-links"></div>
    </div>
</div>
{% else %}
<div class="text-muted fst-italic">Diagnostics PNGs or frames not found for this experiment.</div>
{% endif %}
{% endif %}
{% endblock %}

{% block extra_scripts %}
<script>
document.addEventListener("DOMContentLoaded", () => {
    const tooltipTriggerList = Array.from(document.querySelectorAll('[data-bs-toggle="tooltip"]'));
    tooltipTriggerList.forEach((el) => {
        if (window.bootstrap) {
            new bootstrap.Tooltip(el);
        }
    });
});
</script>
{% if experiment and step_count %}
<script>
document.addEventListener("DOMContentLoaded", () => {
    const viewLabel = "{{ view_label }}";
    const deltaKey = viewLabel === "h"
        ? "delta_h_pca"
        : (viewLabel === "p" ? "delta_p_pca" : "delta_z_pca");
    const alignmentKey = viewLabel === "h"
        ? "action_alignment_detail_h"
        : (viewLabel === "p" ? "action_alignment_detail_p" : "action_alignment_detail");
    const cycleKey = viewLabel === "h"
        ? "cycle_error_h"
        : (viewLabel === "p" ? "cycle_error_p" : "cycle_error");
    const selfDistanceKey = viewLabel === "h"
        ? "self_distance_h"
        : (viewLabel === "p" ? "self_distance_p" : "self_distance");
    const deltaTitle = viewLabel === "h"
        ? "Delta-h PCA"
        : (viewLabel === "p" ? "Delta-p PCA" : "Delta-z PCA");
    const alignmentTitle = viewLabel === "h"
        ? "Action alignment (H)"
        : (viewLabel === "p" ? "Action alignment (P)" : "Action alignment");
    const cycleTitle = viewLabel === "h"
        ? "Cycle error (H)"
        : (viewLabel === "p" ? "Cycle error (P)" : "Cycle error (Z)");
    const selfDistanceTitle = viewLabel === "h"
        ? "Self-distance (H)"
        : (viewLabel === "p" ? "Self-distance (P)" : "Self-distance (Z)");
    const DIAGNOSTICS_CONFIG = {
        targets: {
            [deltaKey]: {
                img: document.getElementById("diagnostics-delta-img"),
                caption: document.getElementById("diagnostics-delta-caption"),
                header: document.getElementById("diagnostics-delta-header"),
                title: deltaTitle,
                label: deltaKey,
            },
            [alignmentKey]: {
                img: document.getElementById("diagnostics-alignment-detail-img"),
                caption: document.getElementById("diagnostics-alignment-detail-caption"),
                header: document.getElementById("diagnostics-alignment-detail-header"),
                title: alignmentTitle,
                label: alignmentKey,
            },
            [cycleKey]: {
                img: document.getElementById("diagnostics-cycle-img"),
                caption: document.getElementById("diagnostics-cycle-caption"),
                header: document.getElementById("diagnostics-cycle-header"),
                title: cycleTitle,
                label: cycleKey,
            },
            [selfDistanceKey]: {
                img: document.getElementById("diagnostics-self-distance-img"),
                caption: document.getElementById("diagnostics-self-distance-caption"),
                header: document.getElementById("diagnostics-self-distance-header"),
                title: selfDistanceTitle,
                label: selfDistanceKey,
            },
            rollout_divergence: {
                img: document.getElementById("diagnostics-rollout-img"),
                caption: document.getElementById("diagnostics-rollout-caption"),
                header: document.getElementById("diagnostics-rollout-header"),
                title: "Rollout divergence",
                label: "vis_rollout_divergence",
            },
            z_consistency: {
                img: document.getElementById("diagnostics-consistency-img"),
                caption: document.getElementById("diagnostics-consistency-caption"),
                header: document.getElementById("diagnostics-consistency-header"),
                title: "Z consistency",
                label: "vis_z_consistency",
            },
            z_monotonicity: {
                img: document.getElementById("diagnostics-monotonicity-img"),
                caption: document.getElementById("diagnostics-monotonicity-caption"),
                header: document.getElementById("diagnostics-monotonicity-header"),
                title: "Z monotonicity",
                label: "vis_z_monotonicity",
            },
            path_independence: {
                img: document.getElementById("diagnostics-path-img"),
                caption: document.getElementById("diagnostics-path-caption"),
                header: document.getElementById("diagnostics-path-header"),
                title: "Path independence",
                label: "vis_path_independence",
            },
            straightline_p: {
                img: document.getElementById("diagnostics-straightline-img"),
                caption: document.getElementById("diagnostics-straightline-caption"),
                header: document.getElementById("diagnostics-straightline-header"),
                title: "Straight-line action rays (P)",
                label: "vis_straightline_p",
            },
            h_ablation: {
                img: document.getElementById("diagnostics-h-ablation-img"),
                caption: document.getElementById("diagnostics-h-ablation-caption"),
                header: document.getElementById("diagnostics-h-ablation-header"),
                title: "H ablation divergence",
                label: "vis_h_ablation",
            },
            h_drift_by_action: {
                img: document.getElementById("diagnostics-h-drift-img"),
                caption: document.getElementById("diagnostics-h-drift-caption"),
                header: document.getElementById("diagnostics-h-drift-header"),
                title: "H drift by action",
                label: "vis_h_drift_by_action",
            },
            norm_timeseries: {
                img: document.getElementById("diagnostics-norm-img"),
                caption: document.getElementById("diagnostics-norm-caption"),
                header: document.getElementById("diagnostics-norm-header"),
                title: "Norm stability",
                label: "vis_norm_timeseries",
            },
        },
        hasAlignmentSummary: true,
        hasFrameSteps: true,
        hasCsvLinks: true,
    };

    const serverData = {
        steps: {{ steps | tojson }},
        diagnostics: {{ diagnostics_map | tojson }},
        frameMap: {{ frame_map | tojson }},
        diagSummary: {{ diagnostics_summary | tojson if diagnostics_summary is not none else 'null' }},
        figure: {{ figure | tojson if figure else 'null' }},
        diagScalars: {{ diagnostics_scalars | tojson if diagnostics_scalars is not none else '{}' }},
    };

    initializeDiagnosticsPage(DIAGNOSTICS_CONFIG, serverData);
});
</script>
{% endif %}
{% endblock %}
