{% extends "base.html" %}

{% set frame_steps = frame_map.keys()|list|sort if frame_map is defined else [] %}
{% set steps = experiment.diagnostics_steps if experiment and experiment.diagnostics_steps else frame_steps %}
{% set step_count = steps|length %}

{% block extra_head %}
<script src="https://cdn.plot.ly/plotly-2.27.0.min.js"></script>
<script src="{{ url_for('static', filename='plotly_utils.js') }}"></script>
{% endblock %}

{% block body %}
<style>
.diagnostic-frame-img {
    min-width: 224px;
    min-height: 224px;
    width: 100%;
    max-width: 420px;
    height: auto;
    object-fit: contain;
    background-color: #f8f9fa;
}

.diagnostic-grid-top,
.diagnostic-grid-bottom {
    display: grid;
    grid-auto-rows: 1fr;
    gap: 0.75rem;
}

.diagnostic-grid-top {
    grid-template-columns: repeat(4, minmax(0, 1fr));
}

.diagnostic-grid-bottom {
    grid-template-columns: repeat(2, minmax(0, 1fr));
}

.diag-delta {
    grid-column: 1 / span 2;
    grid-row: 1 / span 2;
}

.diag-align-detail {
    grid-column: 3 / span 2;
    grid-row: 1 / span 2;
}

.diag-self-distance,
.diag-self-distance-s {
    grid-column: 1 / span 2;
}

.diag-cycle,
.diag-cycle-s {
    grid-column: 2 / span 1;
}

.diagnostics-loss-wrapper {
    position: relative;
}

.diagnostics-loss-plot {
    height: 220px;
}

.diagnostics-pin-btn {
    position: absolute;
    bottom: 10px;
    right: 10px;
    width: 32px;
    height: 32px;
    border-radius: 999px;
    display: inline-flex;
    align-items: center;
    justify-content: center;
    background-color: rgba(255, 255, 255, 0.9);
    border: 1px solid #ced4da;
    color: #6c757d;
    z-index: 5;
    box-shadow: 0 2px 6px rgba(0, 0, 0, 0.08);
    transition: transform 0.15s ease-in-out, box-shadow 0.15s ease-in-out, background-color 0.15s ease-in-out, color 0.15s ease-in-out, border-color 0.15s ease-in-out;
}

.diagnostics-pin-btn:hover {
    transform: translateY(-1px);
    box-shadow: 0 4px 10px rgba(0, 0, 0, 0.12);
}

.diagnostics-pin-btn.active {
    background-color: #0d6efd;
    border-color: #0a58ca;
    color: #fff;
}

.diagnostics-loss-wrapper.sticky-active {
    position: sticky;
    top: 0;
    z-index: 1030;
    background: #fff;
    border-radius: 0.5rem;
    box-shadow: 0 0.5rem 1rem rgba(0, 0, 0, 0.08);
}

.diagnostic-subtitle {
    font-size: 0.88em;
    color: #6c757d;
    font-weight: 400;
    margin-left: 4px;
 }

@media (max-width: 991.98px) {
    .diagnostic-grid-top,
    .diagnostic-grid-bottom {
        grid-template-columns: repeat(2, minmax(0, 1fr));
    }
    .diag-delta,
    .diag-align-detail,
    .diag-self-distance,
    .diag-self-distance-s {
        grid-column: 1 / span 2;
        grid-row: auto;
    }
    .diag-cycle,
    .diag-cycle-s {
        grid-column: span 1;
    }
}

@media (max-width: 575.98px) {
    .diagnostic-grid {
        grid-template-columns: 1fr;
    }
    .diag-delta,
    .diag-align-detail,
    .diag-self-distance,
    .diag-self-distance-s,
    .diag-cycle,
    .diag-cycle-s {
        grid-column: 1;
        grid-row: auto;
    }
}
</style>
<div class="d-flex align-items-center justify-content-between flex-wrap gap-2 mb-3">
    <div class="d-flex align-items-center gap-2 flex-wrap">
        {% if experiment %}
        <h3 class="mb-1">{{ experiment.title if experiment.title != "Untitled" else "Untitled" }} <small class="text-muted">({{ experiment.id }})</small></h3>
        {% else %}
        <h3 class="mb-1">Diagnostics</h3>
        <div class="text-muted small">No experiments with diagnostics outputs.</div>
        {% endif %}
    </div>
    {% if experiment %}
    <div class="d-flex align-items-center gap-2 flex-wrap">
        <button
            class="btn btn-sm btn-outline-secondary"
            type="button"
            id="diagnostics-toggle-btn"
            data-bs-toggle="collapse"
            data-bs-target="#diagnostics-top-grid"
            aria-expanded="true"
            aria-controls="diagnostics-top-grid"
        >
            Collapse Delta/Alignment
        </button>
    </div>
    {% endif %}
</div>

{% if not experiment %}
<div class="text-muted fst-italic">No diagnostics images found in any experiments.</div>
{% else %}

{% if step_count %}
<div class="diagnostics-loss-wrapper mb-3" id="diagnostics-loss-wrapper">
    <button
        type="button"
        class="diagnostics-pin-btn"
        id="diagnostics-loss-pin"
        aria-pressed="false"
        aria-label="Pin diagnostics plot"
        title="Pin diagnostics plot"
    >
        <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="currentColor" viewBox="0 0 16 16">
            <path d="M4.146.146A.5.5 0 0 1 4.5 0h7a.5.5 0 0 1 .5.5c0 .68-.342 1.174-.646 1.479-.126.125-.25.224-.354.298v4.431l.078.048c.203.127.476.314.751.555C12.36 7.775 13 8.527 13 9.5a.5.5 0 0 1-.5.5h-4v4.5c0 .276-.224 1.5-.5 1.5s-.5-1.224-.5-1.5V10h-4a.5.5 0 0 1-.5-.5c0-.973.64-1.725 1.17-2.189A6 6 0 0 1 5 6.708V2.277a3 3 0 0 1-.354-.298C4.342 1.674 4 1.179 4 .5a.5.5 0 0 1 .146-.354"/>
        </svg>
    </button>
    <div id="diagnostics-loss-plot" class="diagnostics-loss-plot"></div>
</div>
<div id="diagnostics-top-grid" class="collapse show">
    <div class="diagnostic-grid-top mb-3">
        <div class="card h-100 diag-delta">
            <div class="card-header py-2" id="diagnostics-delta-header">Delta-z PCA</div>
            <div class="card-body d-flex flex-column gap-2">
                <img id="diagnostics-delta-img" class="img-fluid rounded border d-none" alt="Delta-z PCA diagnostic">
                <div class="text-muted small" id="diagnostics-delta-caption"></div>
            </div>
        </div>
        <div class="card h-100 diag-align-detail">
            <div class="card-header py-2" id="diagnostics-alignment-detail-header">Alignment detail</div>
            <div class="card-body d-flex flex-column gap-2">
                <img id="diagnostics-alignment-detail-img" class="img-fluid rounded border d-none" alt="Alignment detail diagnostic">
                <div class="text-muted small" id="diagnostics-alignment-detail-caption"></div>
            </div>
        </div>
    </div>
</div>
<div class="diagnostic-grid-bottom mb-3">
    <div class="card h-100 diag-self-distance">
        <div class="card-header py-2" id="diagnostics-self-distance-header">Self-distance (Z)</div>
        <div class="card-body d-flex flex-column gap-2">
            <img id="diagnostics-self-distance-img" class="img-fluid rounded border d-none" alt="Self-distance diagnostic">
            <div class="text-muted small" id="diagnostics-self-distance-caption"></div>
        </div>
    </div>
    <div class="card h-100 diag-cycle">
        <div class="card-header py-2" id="diagnostics-cycle-header">Cycle error (Z)</div>
        <div class="card-body d-flex flex-column gap-2">
            <img id="diagnostics-cycle-img" class="img-fluid rounded border d-none" alt="Cycle error diagnostic">
            <div class="text-muted small" id="diagnostics-cycle-caption"></div>
        </div>
    </div>
</div>
<div class="diagnostic-grid-bottom mb-3">
    <div class="card h-100 diag-self-distance-s">
        <div class="card-header py-2" id="diagnostics-self-distance-s-header">Self-distance (S)</div>
        <div class="card-body d-flex flex-column gap-2">
            <img id="diagnostics-self-distance-s-img" class="img-fluid rounded border d-none" alt="Self-distance (S) diagnostic">
            <div class="text-muted small" id="diagnostics-self-distance-s-caption"></div>
        </div>
    </div>
    <div class="card h-100 diag-cycle-s">
        <div class="card-header py-2" id="diagnostics-cycle-s-header">Cycle error (S)</div>
        <div class="card-body d-flex flex-column gap-2">
            <img id="diagnostics-cycle-s-img" class="img-fluid rounded border d-none" alt="Cycle error (S) diagnostic">
            <div class="text-muted small" id="diagnostics-cycle-s-caption"></div>
        </div>
    </div>
</div>
<div class="card mt-3">
    <div class="card-header py-2">Diagnostic frames</div>
    <div class="card-body">
        <div class="mb-2">
            <label for="diagnostics-frame" class="form-label mb-1">Select frame</label>
            <input type="range" class="form-range" id="diagnostics-frame" min="0" max="0" step="1" value="0" disabled>
            <div class="small text-muted d-flex justify-content-between">
                <span>Count: <span id="diagnostics-frame-count">0</span></span>
                <span id="diagnostics-frame-label">No frame selected</span>
            </div>
        </div>
        <img id="diagnostics-frame-img" class="rounded border d-none diagnostic-frame-img" alt="Diagnostic frame preview">
        <div class="small text-muted" id="diagnostics-frame-action"></div>
        <div class="small text-muted font-monospace mt-1" id="diagnostics-frame-path"></div>
        <div class="small text-muted" id="diagnostics-frame-dimensions"></div>
    </div>
</div>
<div class="card mt-3 d-none" id="diagnostics-summary-wrapper">
    <div class="card-header py-2 d-flex justify-content-between align-items-center">
        <span>Alignment snapshot</span>
        <span class="badge text-bg-light" id="diagnostics-summary-step">Latest</span>
    </div>
    <div class="card-body">
        <div class="small text-muted" id="diagnostics-summary-caption">
            Parsed from the latest action_alignment_report and action_alignment_strength outputs.
        </div>
        <div class="table-responsive mt-2">
            <table class="table table-sm table-striped align-middle mb-0">
                <thead>
                    <tr>
                        <th scope="col">Action</th>
                        <th scope="col">Count</th>
                        <th scope="col">Mean cos</th>
                        <th scope="col">Pct &gt; thr</th>
                        <th scope="col">Δ norm (med)</th>
                        <th scope="col">Δ norm (p90)</th>
                        <th scope="col">Strength</th>
                        <th scope="col">Notes</th>
                    </tr>
                </thead>
                <tbody id="diagnostics-summary-body">
                    <tr class="text-muted">
                        <td colspan="8">No alignment summary available.</td>
                    </tr>
                </tbody>
            </table>
        </div>
        <div class="small text-muted mt-1" id="diagnostics-summary-links"></div>
    </div>
</div>
{% else %}
<div class="text-muted fst-italic">Diagnostics PNGs or frames not found for this experiment.</div>
{% endif %}
{% endif %}
{% endblock %}

{% block extra_scripts %}
{% if experiment and step_count %}
<script>
document.addEventListener("DOMContentLoaded", () => {
    const steps = {{ steps | tojson }};
    const diagnostics = {{ diagnostics_map | tojson }};
    const frameMap = {{ frame_map | tojson }};
    const diagSummary = {{ diagnostics_summary | tojson if diagnostics_summary is not none else 'null' }};
    const frameSteps = Object.keys(frameMap || {}).map((k) => Number(k)).filter((n) => !Number.isNaN(n)).sort((a, b) => a - b);
    const stepLabel = document.getElementById("diagnostics-step-label");
    const lossPlot = document.getElementById("diagnostics-loss-plot");
    const lossWrapper = document.getElementById("diagnostics-loss-wrapper");
    const lossPinButton = document.getElementById("diagnostics-loss-pin");
    const figure = {{ figure | tojson if figure else 'null' }};
    const topGrid = document.getElementById("diagnostics-top-grid");
    const toggleBtn = document.getElementById("diagnostics-toggle-btn");
    const targets = {
        delta_z_pca: {
            img: document.getElementById("diagnostics-delta-img"),
            caption: document.getElementById("diagnostics-delta-caption"),
            header: document.getElementById("diagnostics-delta-header"),
            title: "Delta-z PCA",
            label: "vis_delta_z_pca",
        },
        action_alignment_detail: {
            img: document.getElementById("diagnostics-alignment-detail-img"),
            caption: document.getElementById("diagnostics-alignment-detail-caption"),
            header: document.getElementById("diagnostics-alignment-detail-header"),
            title: "Alignment detail",
            label: "alignment detail",
        },
        cycle_error: {
            img: document.getElementById("diagnostics-cycle-img"),
            caption: document.getElementById("diagnostics-cycle-caption"),
            header: document.getElementById("diagnostics-cycle-header"),
            title: "Cycle error (Z)",
            label: "vis_cycle_error",
        },
        self_distance: {
            img: document.getElementById("diagnostics-self-distance-img"),
            caption: document.getElementById("diagnostics-self-distance-caption"),
            header: document.getElementById("diagnostics-self-distance-header"),
            title: "Self-distance (Z)",
            label: "self_distance",
        },
        self_distance_s: {
            img: document.getElementById("diagnostics-self-distance-s-img"),
            caption: document.getElementById("diagnostics-self-distance-s-caption"),
            header: document.getElementById("diagnostics-self-distance-s-header"),
            title: "Self-distance (S)",
            label: "self_distance_s",
        },
        cycle_error_s: {
            img: document.getElementById("diagnostics-cycle-s-img"),
            caption: document.getElementById("diagnostics-cycle-s-caption"),
            header: document.getElementById("diagnostics-cycle-s-header"),
            title: "Cycle error (S)",
            label: "vis_cycle_error_s",
        },
    };
    const frameSlider = document.getElementById("diagnostics-frame");
    const frameCount = document.getElementById("diagnostics-frame-count");
    const frameLabel = document.getElementById("diagnostics-frame-label");
    const frameImg = document.getElementById("diagnostics-frame-img");
    const framePath = document.getElementById("diagnostics-frame-path");
    const frameAction = document.getElementById("diagnostics-frame-action");
    const frameDimensions = document.getElementById("diagnostics-frame-dimensions");
    const summaryWrapper = document.getElementById("diagnostics-summary-wrapper");
    const summaryBody = document.getElementById("diagnostics-summary-body");
    const summaryStep = document.getElementById("diagnostics-summary-step");
    const summaryLinks = document.getElementById("diagnostics-summary-links");
    const summaryCaption = document.getElementById("diagnostics-summary-caption");
    let hasHover = false;
    let currentFrames = [];
    let lossPinned = false;

    // Update CSV links for the selected step if present (no-op fallback).
    function populateCsvLinks(step) {
        const csvLink = document.getElementById("diagnostics-csv-link");
        if (!csvLink || !diagnostics?.csv_base_url) return;
        const nearest = nearestStep(step);
        const resolvedStep = nearest !== null ? nearest : step;
        csvLink.href = `${diagnostics.csv_base_url}/${resolvedStep}.csv`;
        csvLink.classList.remove("d-none");
    }

    function resolveUrl(diagKey, step) {
        const perDiag = diagnostics[diagKey] || {};
        return perDiag[step] || perDiag[String(step)] || null;
    }

    function updateFrameForIndex(idx) {
        if (!frameImg || !frameLabel || !currentFrames.length) return;
        const clamped = Math.min(Math.max(idx, 0), currentFrames.length - 1);
        const frame = currentFrames[clamped];
        frameImg.src = frame.url;
        frameImg.classList.remove("d-none");
        frameLabel.textContent = `Frame ${clamped + 1} / ${currentFrames.length}`;
        if (frameAction) {
            const label = frame.action || (frame.action_id ? `action ${frame.action_id}` : "");
            frameAction.textContent = label ? `Action: ${label}` : "Action: (unknown)";
        }
        if (framePath) {
            framePath.textContent = frame.source || "Unknown source path";
        }
        if (frameDimensions) {
            frameDimensions.textContent = frameImg.naturalWidth && frameImg.naturalHeight
                ? `Image size: ${frameImg.naturalWidth}×${frameImg.naturalHeight}px`
                : "Loading dimensions…";
        }
    }

    function updateFrameSlider(step) {
        if (!frameSlider || !frameCount || !frameLabel || !frameImg) return;
        const frames = frameMap[step] || frameMap[String(step)] || [];
        currentFrames = frames;
        if (!frames.length) {
            frameSlider.disabled = true;
            frameSlider.max = 0;
            frameSlider.value = 0;
            frameCount.textContent = "0";
            frameLabel.textContent = "No frames for this step";
            frameImg.classList.add("d-none");
            if (framePath) {
                framePath.textContent = "";
            }
            if (frameAction) {
                frameAction.textContent = "";
            }
            if (frameDimensions) {
                frameDimensions.textContent = "";
            }
            return;
        }
        frameSlider.disabled = false;
        frameSlider.max = frames.length - 1;
        const newVal = Math.min(Number(frameSlider.value || 0), frames.length - 1);
        frameSlider.value = newVal;
        frameCount.textContent = String(frames.length);
        updateFrameForIndex(newVal);
    }

    function formatNumber(value, decimals = 3, multiplier = 1) {
        if (value === null || value === undefined) return "—";
        const num = Number(value);
        if (!Number.isFinite(num)) return "—";
        return (num * multiplier).toFixed(decimals);
    }

    function renderAlignmentSummary(summary) {
        if (!summaryWrapper) return;
        if (!summary || !Array.isArray(summary.rows) || summary.rows.length === 0) {
            summaryWrapper.classList.add("d-none");
            return;
        }
        summaryWrapper.classList.remove("d-none");
        if (summaryStep) {
            summaryStep.textContent = summary.step !== null && summary.step !== undefined ? `Step ${summary.step}` : "Latest";
        }
        if (summaryBody) {
            summaryBody.innerHTML = "";
            const rows = summary.rows.slice(0, 12);
            rows.forEach((row) => {
                const tr = document.createElement("tr");
                const notes = [row.note, row.strength_note].filter((n) => n && n.trim());
                const cells = [
                    row.label || `Action ${row.action_id}`,
                    row.count ?? "—",
                    formatNumber(row.mean, 3),
                    `${formatNumber(row.pct_high, 1, 100)}%`,
                    formatNumber(row.delta_norm_median, 4),
                    formatNumber(row.delta_norm_p90, 4),
                    formatNumber(row.strength_ratio ?? row.mean_dir_norm, 3),
                    notes.length ? notes.join("; ") : "",
                ];
                cells.forEach((value) => {
                    const td = document.createElement("td");
                    td.textContent = value === undefined ? "—" : value;
                    tr.appendChild(td);
                });
                summaryBody.appendChild(tr);
            });
        }
        if (summaryLinks) {
            const links = [];
            if (summary.report_url) {
                const label = summary.report_name || "Report";
                links.push(`<a href="${summary.report_url}" target="_blank" rel="noreferrer">${label}</a>`);
            }
            if (summary.strength_url && summary.strength_url !== summary.report_url) {
                const label = summary.strength_name || "Strength";
                links.push(`<a href="${summary.strength_url}" target="_blank" rel="noreferrer">${label}</a>`);
            }
            const extras = [];
            if (!summary.report_url && summary.report_name) {
                extras.push(summary.report_name);
            }
            if (!summary.strength_url && summary.strength_name) {
                extras.push(summary.strength_name);
            }
            const extraText = extras.length ? extras.join(" · ") : "";
            const linkText = links.length ? links.join(" · ") : "";
            const combined = [linkText, extraText].filter(Boolean).join(" · ");
            summaryLinks.innerHTML = combined ? `Sources: ${combined}` : "";
        }
        if (summaryCaption) {
            summaryCaption.textContent = "Parsed from the latest action_alignment_report and action_alignment_strength outputs.";
        }
    }

    function nearestStep(target) {
        if (!steps.length) return null;
        let best = steps[0];
        let bestDiff = Math.abs(target - steps[0]);
        for (let i = 1; i < steps.length; i++) {
            const diff = Math.abs(target - steps[i]);
            if (diff < bestDiff) {
                best = steps[i];
                bestDiff = diff;
            }
        }
        return best;
    }

    function updateForStep(stepValue) {
        const nearest = nearestStep(stepValue);
        const step = nearest !== null ? nearest : steps[steps.length - 1];
        if (stepLabel) stepLabel.textContent = step ?? "—";
        Object.entries(targets).forEach(([key, refs]) => {
            if (!refs.img || !refs.caption) return;
            const url = resolveUrl(key, step);
            const headerText = refs.title ? refs.title : "";
            if (url) {
                refs.img.src = url;
                refs.img.classList.remove("d-none");
                if (refs.header) {
                    refs.header.innerHTML = `${headerText} <span class="diagnostic-subtitle">(${refs.label} @ step ${step})</span>`;
                }
                refs.caption.textContent = "";
            } else {
                refs.img.classList.add("d-none");
                if (refs.header) {
                    refs.header.textContent = headerText;
                }
                refs.caption.textContent = `No image for step ${step} in ${refs.label}`;
            }
        });
        populateCsvLinks(step);
        updateFrameSlider(step);
        renderAlignmentSummary(diagSummary);
    }

    function renderLossPlot() {
        if (!lossPlot) return;
        if (typeof Plotly === "undefined") {
            return;
        }
        if (!figure || !figure.data || !figure.layout) {
            return;
        }
        const layout = {
            ...figure.layout,
            height: 220,
            margin: { ...(figure.layout?.margin || {}), t: 30, b: 50, l: 50, r: 10 },
        };
        const config = buildPlotlyConfig(figure.config || {});
        Plotly.react(lossPlot, figure.data, layout, config).then(() => {
            lossPlot.on("plotly_hover", (event) => {
                const point = event?.points?.[0];
                if (!point || typeof point.x === "undefined") return;
                updateForStep(point.x);
            });
        });
    }

    // Toggle sticky positioning for the diagnostics loss plot.
    function setLossPinned(pinned) {
        if (!lossWrapper || !lossPinButton) return;
        lossPinned = pinned;
        lossWrapper.classList.toggle("sticky-active", pinned);
        lossPinButton.classList.toggle("active", pinned);
        lossPinButton.setAttribute("aria-pressed", pinned ? "true" : "false");
        lossPinButton.setAttribute("title", pinned ? "Unpin diagnostics plot" : "Pin diagnostics plot");
    }

    // Ensure initial state is rendered.
    setLossPinned(true);

    if (frameSlider) {
        frameSlider.addEventListener("input", (ev) => {
            updateFrameForIndex(Number(ev.target.value));
        });
        frameSlider.addEventListener("pointermove", (ev) => {
            if (!currentFrames.length || frameSlider.disabled) return;
            const rect = frameSlider.getBoundingClientRect();
            if (!rect || rect.width === 0) return;
            const ratio = Math.min(Math.max((ev.clientX - rect.left) / rect.width, 0), 1);
            const idx = Math.round(ratio * (currentFrames.length - 1));
            frameSlider.value = String(idx);
            updateFrameForIndex(idx);
        });
    }
    if (frameImg && frameDimensions) {
        frameImg.addEventListener("load", () => {
            if (!frameImg.naturalWidth || !frameImg.naturalHeight) {
                frameDimensions.textContent = "";
                return;
            }
            frameDimensions.textContent = `Image size: ${frameImg.naturalWidth}×${frameImg.naturalHeight}px`;
        });
    }

    renderLossPlot();
    const initialStep = steps.length ? steps[steps.length - 1] : (frameSteps.length ? frameSteps[frameSteps.length - 1] : null);
    const initialFrameStep = frameSteps.length ? frameSteps[0] : initialStep;
    if (initialFrameStep !== null) {
        updateFrameSlider(initialFrameStep);
    }
    if (initialStep !== null) {
        updateForStep(initialStep);
    } else {
        renderAlignmentSummary(diagSummary);
    }

    if (toggleBtn && topGrid) {
        topGrid.addEventListener("shown.bs.collapse", () => {
            toggleBtn.textContent = "Collapse Delta/Alignment";
            toggleBtn.setAttribute("aria-expanded", "true");
        });
        topGrid.addEventListener("hidden.bs.collapse", () => {
            toggleBtn.textContent = "Expand Delta/Alignment";
            toggleBtn.setAttribute("aria-expanded", "false");
        });
    }
    if (lossPinButton && lossWrapper) {
        lossPinButton.addEventListener("click", () => {
            setLossPinned(!lossPinned);
        });
    }
});
</script>
{% endif %}
{% endblock %}
