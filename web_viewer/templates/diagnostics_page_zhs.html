{% extends "base.html" %}

{% set steps = diagnostic_steps if diagnostic_steps is defined else [] %}
{% set step_count = steps|length %}

{% block extra_head %}
<link rel="stylesheet" href="{{ url_for('static', filename='common_styles.css') }}">
<script src="https://cdn.plot.ly/plotly-2.27.0.min.js"></script>
<script src="{{ url_for('static', filename='plotly_utils.js') }}"></script>
{% endblock %}

{% block body %}
<div class="d-flex align-items-center justify-content-between flex-wrap gap-2 mb-3">
    <div class="d-flex align-items-center gap-2 flex-wrap">
        {% if experiment %}
        {% set heading_title = experiment.title if experiment.title != "Untitled" else experiment.name %}
        <h3 class="mb-1">{{ heading_title }} <small class="text-muted">({{ experiment.id }})</small></h3>
        {% else %}
        <h3 class="mb-1">Diagnostics (Z/H/P/F)</h3>
        <div class="text-muted small">No experiments with diagnostics outputs.</div>
        {% endif %}
    </div>
</div>

{% if not experiment %}
<div class="text-muted fst-italic">No diagnostics images found in any experiments.</div>
{% else %}

{% if step_count %}
<div class="diagnostic-status-strip mb-3" id="diagnostics-status-strip">
    <div class="diagnostic-status-item">
        <div class="diagnostic-status-label">||z|| mean</div>
        <div class="diagnostic-status-value" data-status-metric="z_norm_mean">—</div>
    </div>
    <div class="diagnostic-status-item">
        <div class="diagnostic-status-label">||z|| p95</div>
        <div class="diagnostic-status-value" data-status-metric="z_norm_p95">—</div>
    </div>
    <div class="diagnostic-status-item">
        <div class="diagnostic-status-label">||h|| mean</div>
        <div class="diagnostic-status-value" data-status-metric="h_norm_mean">—</div>
    </div>
    <div class="diagnostic-status-item">
        <div class="diagnostic-status-label">||h|| p95</div>
        <div class="diagnostic-status-value" data-status-metric="h_norm_p95">—</div>
    </div>
    <div class="diagnostic-status-item">
        <div class="diagnostic-status-label">||p|| mean</div>
        <div class="diagnostic-status-value" data-status-metric="p_norm_mean">—</div>
    </div>
    <div class="diagnostic-status-item">
        <div class="diagnostic-status-label">||p|| p95</div>
        <div class="diagnostic-status-value" data-status-metric="p_norm_p95">—</div>
    </div>
    <div class="diagnostic-status-item">
        <div class="diagnostic-status-label">H drift</div>
        <div class="diagnostic-status-value" data-status-metric="h_drift_mean">—</div>
    </div>
    <div class="diagnostic-status-item">
        <div class="diagnostic-status-label">P drift</div>
        <div class="diagnostic-status-value" data-status-metric="p_drift_mean">—</div>
    </div>
    <div class="diagnostic-status-item">
        <div class="diagnostic-status-label">ID acc (P)</div>
        <div class="diagnostic-status-value" data-status-metric="id_acc_p">—</div>
    </div>
    <div class="diagnostic-status-item">
        <div class="diagnostic-status-label">||f|| mean</div>
        <div class="diagnostic-status-value" data-status-metric="f_norm_mean">—</div>
    </div>
    <div class="diagnostic-status-item">
        <div class="diagnostic-status-label">||f|| p95</div>
        <div class="diagnostic-status-value" data-status-metric="f_norm_p95">—</div>
    </div>
</div>
<div class="plot-pin-wrapper mb-3" id="diagnostics-loss-wrapper">
    <button
        type="button"
        class="plot-pin-btn"
        id="diagnostics-loss-pin"
        aria-pressed="false"
        aria-label="Pin diagnostics plot"
        title="Pin diagnostics plot"
    >
        <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="currentColor" viewBox="0 0 16 16">
            <path d="M4.146.146A.5.5 0 0 1 4.5 0h7a.5.5 0 0 1 .5.5c0 .68-.342 1.174-.646 1.479-.126.125-.25.224-.354.298v4.431l.078.048c.203.127.476.314.751.555C12.36 7.775 13 8.527 13 9.5a.5.5 0 0 1-.5.5h-4v4.5c0 .276-.224 1.5-.5 1.5s-.5-1.224-.5-1.5V10h-4a.5.5 0 0 1-.5-.5c0-.973.64-1.725 1.17-2.189A6 6 0 0 1 5 6.708V2.277a3 3 0 0 1-.354-.298C4.342 1.674 4 1.179 4 .5a.5.5 0 0 1 .146-.354"/>
        </svg>
    </button>
    <div id="diagnostics-loss-plot" class="diagnostics-loss-plot"></div>
</div>

<div class="diagnostic-zhs-grid mb-3">
    <div class="diagnostic-zhs-col">
        <div class="card h-100">
            <div class="card-header py-2 d-flex justify-content-between align-items-center" id="diagnostics-z-delta-header">
                <span class="image-preview-card-title">Delta-z PCA</span>
                <div class="d-flex align-items-center gap-2">
                    <span class="text-muted small">Step: <span class="step-label-value">—</span></span>
                    <span
                        class="diagnostic-info-icon"
                        data-bs-toggle="tooltip"
                        data-bs-placement="left"
                        title="PCA of delta-z steps across the batch. Read: spokes or clusters correspond to action directions; separation shows distinct motions. Good: clear, separated clusters with minimal overlap."
                    >i</span>
                </div>
            </div>
            <div class="card-body d-flex flex-column gap-2">
                <img id="diagnostics-z-delta-img" class="img-fluid rounded border d-none" alt="Delta-z PCA diagnostic">
                <div class="text-muted small" id="diagnostics-z-delta-caption"></div>
            </div>
        </div>
        <div class="card h-100">
            <div class="card-header py-2 d-flex justify-content-between align-items-center" id="diagnostics-z-align-header">
                <span class="image-preview-card-title">Action alignment (Z)</span>
                <div class="d-flex align-items-center gap-2">
                    <span class="text-muted small">Step: <span class="step-label-value">—</span></span>
                    <span
                        class="diagnostic-info-icon"
                        data-bs-toggle="tooltip"
                        data-bs-placement="left"
                        title="Per-action cosine alignment of delta-z directions. Read: values near 1 mean consistent action effects; near 0 means noisy alignment. Good: high alignment for common actions with few negative outliers."
                    >i</span>
                </div>
            </div>
            <div class="card-body d-flex flex-column gap-2">
                <img id="diagnostics-z-align-img" class="img-fluid rounded border d-none" alt="Alignment detail diagnostic">
                <div class="text-muted small" id="diagnostics-z-align-caption"></div>
            </div>
        </div>
        <div class="card h-100">
            <div class="card-header py-2 d-flex justify-content-between align-items-center" id="diagnostics-z-self-header">
                <span class="image-preview-card-title">Self-distance (Z)</span>
                <span class="text-muted small">Step: <span class="step-label-value">—</span></span>
            </div>
            <div class="card-body d-flex flex-column gap-2">
                <img id="diagnostics-z-self-img" class="img-fluid rounded border d-none" alt="Self-distance (Z) diagnostic">
                <div class="text-muted small" id="diagnostics-z-self-caption"></div>
            </div>
        </div>
        <div class="card h-100">
            <div class="card-header py-2 d-flex justify-content-between align-items-center" id="diagnostics-z-cycle-header">
                <span class="image-preview-card-title">Cycle error (Z)</span>
                <span class="text-muted small">Step: <span class="step-label-value">—</span></span>
            </div>
            <div class="card-body d-flex flex-column gap-2">
                <img id="diagnostics-z-cycle-img" class="img-fluid rounded border d-none" alt="Cycle error (Z) diagnostic">
                <div class="text-muted small" id="diagnostics-z-cycle-caption"></div>
            </div>
        </div>
        <div class="card h-100">
            <div class="card-header py-2 d-flex justify-content-between align-items-center" id="diagnostics-z-rollout-header">
                <span class="image-preview-card-title">Rollout divergence</span>
                <div class="d-flex align-items-center gap-2">
                    <span class="text-muted small">Step: <span class="step-label-value">—</span></span>
                    <span class="diagnostic-info-icon" data-bs-toggle="tooltip" data-bs-placement="left" title="Pixel vs latent error over rollout horizon. Read: growing curves show compounding drift.">i</span>
                </div>
            </div>
            <div class="card-body d-flex flex-column gap-2">
                <img id="diagnostics-z-rollout-img" class="img-fluid rounded border d-none" alt="Rollout divergence">
                <div class="text-muted small" id="diagnostics-z-rollout-caption"></div>
            </div>
        </div>
        <div class="card h-100">
            <div class="card-header py-2 d-flex justify-content-between align-items-center" id="diagnostics-z-consistency-header">
                <span class="image-preview-card-title">Z consistency</span>
                <div class="d-flex align-items-center gap-2">
                    <span class="text-muted small">Step: <span class="step-label-value">—</span></span>
                    <span class="diagnostic-info-icon" data-bs-toggle="tooltip" data-bs-placement="left" title="Repeat-encode same frame with small noise. Tight spread means stable z.">i</span>
                </div>
            </div>
            <div class="card-body d-flex flex-column gap-2">
                <img id="diagnostics-z-consistency-img" class="img-fluid rounded border d-none" alt="Z consistency">
                <div class="text-muted small" id="diagnostics-z-consistency-caption"></div>
            </div>
        </div>
        <div class="card h-100">
            <div class="card-header py-2 d-flex justify-content-between align-items-center" id="diagnostics-z-monotonicity-header">
                <span class="image-preview-card-title">Z monotonicity</span>
                <div class="d-flex align-items-center gap-2">
                    <span class="text-muted small">Step: <span class="step-label-value">—</span></span>
                    <span class="diagnostic-info-icon" data-bs-toggle="tooltip" data-bs-placement="left" title="Z distance vs pixel shift. Smooth increasing trend indicates perceptual alignment.">i</span>
                </div>
            </div>
            <div class="card-body d-flex flex-column gap-2">
                <img id="diagnostics-z-monotonicity-img" class="img-fluid rounded border d-none" alt="Z monotonicity">
                <div class="text-muted small" id="diagnostics-z-monotonicity-caption"></div>
            </div>
        </div>
        <div class="card h-100">
            <div class="card-header py-2 d-flex justify-content-between align-items-center" id="diagnostics-z-path-header">
                <span class="image-preview-card-title">Path independence</span>
                <div class="d-flex align-items-center gap-2">
                    <span class="text-muted small">Step: <span class="step-label-value">—</span></span>
                    <span class="diagnostic-info-icon" data-bs-toggle="tooltip" data-bs-placement="left" title="Compare end-state z/s for two paths to the same target. Low bars mean history doesn't leak.">i</span>
                </div>
            </div>
            <div class="card-body d-flex flex-column gap-2">
                <img id="diagnostics-z-path-img" class="img-fluid rounded border d-none" alt="Path independence">
                <div class="text-muted small" id="diagnostics-z-path-caption"></div>
            </div>
        </div>
    </div>
    <div class="diagnostic-zhs-col">
        <div class="card h-100">
            <div class="card-header py-2 d-flex justify-content-between align-items-center" id="diagnostics-h-delta-header">
                <span class="image-preview-card-title">Delta-h PCA</span>
                <div class="d-flex align-items-center gap-2">
                    <span class="text-muted small">Step: <span class="step-label-value">—</span></span>
                    <span
                        class="diagnostic-info-icon"
                        data-bs-toggle="tooltip"
                        data-bs-placement="left"
                        title="PCA of delta-h steps across the batch. Read: spokes or clusters correspond to action directions; separation shows distinct dynamics modes."
                    >i</span>
                </div>
            </div>
            <div class="card-body d-flex flex-column gap-2">
                <img id="diagnostics-h-delta-img" class="img-fluid rounded border d-none" alt="Delta-h PCA diagnostic">
                <div class="text-muted small" id="diagnostics-h-delta-caption"></div>
            </div>
        </div>
        <div class="card h-100">
            <div class="card-header py-2 d-flex justify-content-between align-items-center" id="diagnostics-h-align-header">
                <span class="image-preview-card-title">Action alignment (H)</span>
                <div class="d-flex align-items-center gap-2">
                    <span class="text-muted small">Step: <span class="step-label-value">—</span></span>
                    <span
                        class="diagnostic-info-icon"
                        data-bs-toggle="tooltip"
                        data-bs-placement="left"
                        title="Per-action cosine alignment of delta-h directions. Read: values near 1 mean consistent action effects; near 0 means noisy alignment."
                    >i</span>
                </div>
            </div>
            <div class="card-body d-flex flex-column gap-2">
                <img id="diagnostics-h-align-img" class="img-fluid rounded border d-none" alt="Alignment detail (H) diagnostic">
                <div class="text-muted small" id="diagnostics-h-align-caption"></div>
            </div>
        </div>
        <div class="card h-100">
            <div class="card-header py-2 d-flex justify-content-between align-items-center" id="diagnostics-h-self-header">
                <span class="image-preview-card-title">Self-distance (H)</span>
                <span class="text-muted small">Step: <span class="step-label-value">—</span></span>
            </div>
            <div class="card-body d-flex flex-column gap-2">
                <img id="diagnostics-h-self-img" class="img-fluid rounded border d-none" alt="Self-distance (H) diagnostic">
                <div class="text-muted small" id="diagnostics-h-self-caption"></div>
            </div>
        </div>
        <div class="card h-100">
            <div class="card-header py-2 d-flex justify-content-between align-items-center" id="diagnostics-h-cycle-header">
                <span class="image-preview-card-title">Cycle error (H)</span>
                <span class="text-muted small">Step: <span class="step-label-value">—</span></span>
            </div>
            <div class="card-body d-flex flex-column gap-2">
                <img id="diagnostics-h-cycle-img" class="img-fluid rounded border d-none" alt="Cycle error (H) diagnostic">
                <div class="text-muted small" id="diagnostics-h-cycle-caption"></div>
            </div>
        </div>
        <div class="card h-100">
            <div class="card-header py-2 d-flex justify-content-between align-items-center" id="diagnostics-h-ablation-header">
                <span class="image-preview-card-title">H ablation divergence</span>
                <div class="d-flex align-items-center gap-2">
                    <span class="text-muted small">Step: <span class="step-label-value">—</span></span>
                    <span class="diagnostic-info-icon" data-bs-toggle="tooltip" data-bs-placement="left" title="Compare rollout errors with normal H vs zeroed H. Big gap means H carries dynamics.">i</span>
                </div>
            </div>
            <div class="card-body d-flex flex-column gap-2">
                <img id="diagnostics-h-ablation-img" class="img-fluid rounded border d-none" alt="H ablation">
                <div class="text-muted small" id="diagnostics-h-ablation-caption"></div>
            </div>
        </div>
        <div class="card h-100">
            <div class="card-header py-2 d-flex justify-content-between align-items-center" id="diagnostics-h-drift-header">
                <span class="image-preview-card-title">H drift by action</span>
                <div class="d-flex align-items-center gap-2">
                    <span class="text-muted small">Step: <span class="step-label-value">—</span></span>
                    <span class="diagnostic-info-icon" data-bs-toggle="tooltip" data-bs-placement="left" title="Mean ||h_{t+1}-h_t|| grouped by action. Large deltas suggest hidden dynamics leak.">i</span>
                </div>
            </div>
            <div class="card-body d-flex flex-column gap-2">
                <img id="diagnostics-h-drift-img" class="img-fluid rounded border d-none" alt="H drift by action">
                <div class="text-muted small" id="diagnostics-h-drift-caption"></div>
            </div>
        </div>
        <div class="card h-100">
            <div class="card-header py-2 d-flex justify-content-between align-items-center" id="diagnostics-h-norm-header">
                <span class="image-preview-card-title">Norm stability</span>
                <div class="d-flex align-items-center gap-2">
                    <span class="text-muted small">Step: <span class="step-label-value">—</span></span>
                    <span class="diagnostic-info-icon" data-bs-toggle="tooltip" data-bs-placement="left" title="Mean/p95 norms for z/h/s over steps. Watch for drift or explosion.">i</span>
                </div>
            </div>
            <div class="card-body d-flex flex-column gap-2">
                <img id="diagnostics-h-norm-img" class="img-fluid rounded border d-none" alt="Norm stability">
                <div class="text-muted small" id="diagnostics-h-norm-caption"></div>
            </div>
        </div>
    </div>
    <div class="diagnostic-zhs-col">
        <div class="card h-100">
            <div class="card-header py-2 d-flex justify-content-between align-items-center" id="diagnostics-p-delta-header">
                <span class="image-preview-card-title">Delta-p PCA</span>
                <div class="d-flex align-items-center gap-2">
                    <span class="text-muted small">Step: <span class="step-label-value">—</span></span>
                    <span
                        class="diagnostic-info-icon"
                        data-bs-toggle="tooltip"
                        data-bs-placement="left"
                        title="PCA of delta-p steps across the batch. Read: spokes or clusters correspond to action directions; separation shows distinct motions. Good: clear, separated clusters with minimal overlap."
                    >i</span>
                </div>
            </div>
            <div class="card-body d-flex flex-column gap-2">
                <img id="diagnostics-p-delta-img" class="img-fluid rounded border d-none" alt="Delta-p PCA diagnostic">
                <div class="text-muted small" id="diagnostics-p-delta-caption"></div>
            </div>
        </div>
        <div class="card h-100">
            <div class="card-header py-2 d-flex justify-content-between align-items-center" id="diagnostics-p-align-header">
                <span class="image-preview-card-title">Action alignment (P)</span>
                <div class="d-flex align-items-center gap-2">
                    <span class="text-muted small">Step: <span class="step-label-value">—</span></span>
                    <span
                        class="diagnostic-info-icon"
                        data-bs-toggle="tooltip"
                        data-bs-placement="left"
                        title="Per-action cosine alignment of delta-p directions. Read: values near 1 mean consistent action effects; near 0 means noisy alignment. Good: high alignment for common actions with few negative outliers."
                    >i</span>
                </div>
            </div>
            <div class="card-body d-flex flex-column gap-2">
                <img id="diagnostics-p-align-img" class="img-fluid rounded border d-none" alt="Alignment detail (P) diagnostic">
                <div class="text-muted small" id="diagnostics-p-align-caption"></div>
            </div>
        </div>
        <div class="card h-100">
            <div class="card-header py-2 d-flex justify-content-between align-items-center" id="diagnostics-p-self-header">
                <span class="image-preview-card-title">Self-distance (P)</span>
                <span class="text-muted small">Step: <span class="step-label-value">—</span></span>
            </div>
            <div class="card-body d-flex flex-column gap-2">
                <img id="diagnostics-p-self-img" class="img-fluid rounded border d-none" alt="Self-distance (P) diagnostic">
                <div class="text-muted small" id="diagnostics-p-self-caption"></div>
            </div>
        </div>
        <div class="card h-100">
            <div class="card-header py-2 d-flex justify-content-between align-items-center" id="diagnostics-p-cycle-header">
                <span class="image-preview-card-title">Cycle error (P)</span>
                <span class="text-muted small">Step: <span class="step-label-value">—</span></span>
            </div>
            <div class="card-body d-flex flex-column gap-2">
                <img id="diagnostics-p-cycle-img" class="img-fluid rounded border d-none" alt="Cycle error (P) diagnostic">
                <div class="text-muted small" id="diagnostics-p-cycle-caption"></div>
            </div>
        </div>
        <div class="card h-100">
            <div class="card-header py-2 d-flex justify-content-between align-items-center" id="diagnostics-p-straightline-header">
                <span class="image-preview-card-title">Straight-line action rays (P)</span>
                <div class="d-flex align-items-center gap-2">
                    <span class="text-muted small">Step: <span class="step-label-value">—</span></span>
                    <span class="diagnostic-info-icon" data-bs-toggle="tooltip" data-bs-placement="left" title="Repeated actions in P should trace straight rays; opposite actions should mirror.">i</span>
                </div>
            </div>
            <div class="card-body d-flex flex-column gap-2">
                <img id="diagnostics-p-straightline-img" class="img-fluid rounded border d-none" alt="Straight-line P">
                <div class="text-muted small" id="diagnostics-p-straightline-caption"></div>
            </div>
        </div>
    </div>
    <div class="diagnostic-zhs-col">
        <div class="card h-100">
            <div class="card-header py-2 d-flex justify-content-between align-items-center" id="diagnostics-f-delta-header">
                <span class="image-preview-card-title">Delta-f PCA</span>
                <div class="d-flex align-items-center gap-2">
                    <span class="text-muted small">Step: <span class="step-label-value">—</span></span>
                    <span
                        class="diagnostic-info-icon"
                        data-bs-toggle="tooltip"
                        data-bs-placement="left"
                        title="PCA of delta-f steps across the batch. Read: clusters show descriptor shift patterns; spread indicates sensitivity to action."
                    >i</span>
                </div>
            </div>
            <div class="card-body d-flex flex-column gap-2">
                <img id="diagnostics-f-delta-img" class="img-fluid rounded border d-none" alt="Delta-f PCA diagnostic">
                <div class="text-muted small" id="diagnostics-f-delta-caption"></div>
            </div>
        </div>
        <div class="card h-100">
            <div class="card-header py-2 d-flex justify-content-between align-items-center" id="diagnostics-f-align-header">
                <span class="image-preview-card-title">Action alignment (F)</span>
                <div class="d-flex align-items-center gap-2">
                    <span class="text-muted small">Step: <span class="step-label-value">—</span></span>
                    <span
                        class="diagnostic-info-icon"
                        data-bs-toggle="tooltip"
                        data-bs-placement="left"
                        title="Per-action cosine alignment of delta-f directions. Read: higher means descriptor shifts are consistent for actions."
                    >i</span>
                </div>
            </div>
            <div class="card-body d-flex flex-column gap-2">
                <img id="diagnostics-f-align-img" class="img-fluid rounded border d-none" alt="Alignment detail (F) diagnostic">
                <div class="text-muted small" id="diagnostics-f-align-caption"></div>
            </div>
        </div>
        <div class="card h-100">
            <div class="card-header py-2 d-flex justify-content-between align-items-center" id="diagnostics-f-self-header">
                <span class="image-preview-card-title">Self-distance (F)</span>
                <span class="text-muted small">Step: <span class="step-label-value">—</span></span>
            </div>
            <div class="card-body d-flex flex-column gap-2">
                <img id="diagnostics-f-self-img" class="img-fluid rounded border d-none" alt="Self-distance (F) diagnostic">
                <div class="text-muted small" id="diagnostics-f-self-caption"></div>
            </div>
        </div>
        <div class="card h-100">
            <div class="card-header py-2 d-flex justify-content-between align-items-center" id="diagnostics-f-cycle-header">
                <span class="image-preview-card-title">Cycle error (F)</span>
                <span class="text-muted small">Step: <span class="step-label-value">—</span></span>
            </div>
            <div class="card-body d-flex flex-column gap-2">
                <img id="diagnostics-f-cycle-img" class="img-fluid rounded border d-none" alt="Cycle error (F) diagnostic">
                <div class="text-muted small" id="diagnostics-f-cycle-caption"></div>
            </div>
        </div>
    </div>
</div>
{% else %}
<div class="text-muted fst-italic">Diagnostics PNGs not found for this experiment.</div>
{% endif %}
{% endif %}
{% endblock %}

{% block extra_scripts %}
<script>
document.addEventListener("DOMContentLoaded", () => {
    const tooltipTriggerList = Array.from(document.querySelectorAll('[data-bs-toggle="tooltip"]'));
    tooltipTriggerList.forEach((el) => {
        if (window.bootstrap) {
            new bootstrap.Tooltip(el);
        }
    });
});
</script>
{% if experiment and step_count %}
<script>
document.addEventListener("DOMContentLoaded", () => {
    const steps = {{ steps | tojson }};
    const diagnosticsZ = {{ diagnostics_map_z | tojson }};
    const diagnosticsH = {{ diagnostics_map_h | tojson }};
    const diagnosticsP = {{ diagnostics_map_p | tojson }};
    const diagnosticsF = {{ diagnostics_map_f | tojson }};
    const diagnosticsScalars = {{ diagnostics_scalars | tojson if diagnostics_scalars is not none else '{}' }};
    const stepLabels = document.querySelectorAll(".step-label-value");
    const lossPlot = document.getElementById("diagnostics-loss-plot");
    const lossWrapper = document.getElementById("diagnostics-loss-wrapper");
    const lossPinButton = document.getElementById("diagnostics-loss-pin");
    const figure = {{ figure | tojson if figure else 'null' }};
    let lossPinned = false;

    const targetsZ = {
        delta_z_pca: {
            img: document.getElementById("diagnostics-z-delta-img"),
            caption: document.getElementById("diagnostics-z-delta-caption"),
            header: document.getElementById("diagnostics-z-delta-header"),
            title: "Delta-z PCA",
            label: "vis_delta_z_pca",
        },
        action_alignment_detail: {
            img: document.getElementById("diagnostics-z-align-img"),
            caption: document.getElementById("diagnostics-z-align-caption"),
            header: document.getElementById("diagnostics-z-align-header"),
            title: "Action alignment (Z)",
            label: "action alignment (Z)",
        },
        self_distance: {
            img: document.getElementById("diagnostics-z-self-img"),
            caption: document.getElementById("diagnostics-z-self-caption"),
            header: document.getElementById("diagnostics-z-self-header"),
            title: "Self-distance (Z)",
            label: "self_distance",
        },
        cycle_error: {
            img: document.getElementById("diagnostics-z-cycle-img"),
            caption: document.getElementById("diagnostics-z-cycle-caption"),
            header: document.getElementById("diagnostics-z-cycle-header"),
            title: "Cycle error (Z)",
            label: "vis_cycle_error_z",
        },
        rollout_divergence: {
            img: document.getElementById("diagnostics-z-rollout-img"),
            caption: document.getElementById("diagnostics-z-rollout-caption"),
            header: document.getElementById("diagnostics-z-rollout-header"),
            title: "Rollout divergence",
            label: "vis_rollout_divergence",
        },
        z_consistency: {
            img: document.getElementById("diagnostics-z-consistency-img"),
            caption: document.getElementById("diagnostics-z-consistency-caption"),
            header: document.getElementById("diagnostics-z-consistency-header"),
            title: "Z consistency",
            label: "vis_z_consistency",
        },
        z_monotonicity: {
            img: document.getElementById("diagnostics-z-monotonicity-img"),
            caption: document.getElementById("diagnostics-z-monotonicity-caption"),
            header: document.getElementById("diagnostics-z-monotonicity-header"),
            title: "Z monotonicity",
            label: "vis_z_monotonicity",
        },
        path_independence: {
            img: document.getElementById("diagnostics-z-path-img"),
            caption: document.getElementById("diagnostics-z-path-caption"),
            header: document.getElementById("diagnostics-z-path-header"),
            title: "Path independence",
            label: "vis_path_independence",
        },
    };

    const targetsP = {
        delta_s_pca: {
            img: document.getElementById("diagnostics-p-delta-img"),
            caption: document.getElementById("diagnostics-p-delta-caption"),
            header: document.getElementById("diagnostics-p-delta-header"),
            title: "Delta-p PCA",
            label: "vis_delta_p_pca",
        },
        action_alignment_detail_s: {
            img: document.getElementById("diagnostics-p-align-img"),
            caption: document.getElementById("diagnostics-p-align-caption"),
            header: document.getElementById("diagnostics-p-align-header"),
            title: "Action alignment (P)",
            label: "action alignment (P)",
        },
        self_distance_p: {
            img: document.getElementById("diagnostics-p-self-img"),
            caption: document.getElementById("diagnostics-p-self-caption"),
            header: document.getElementById("diagnostics-p-self-header"),
            title: "Self-distance (P)",
            label: "self_distance_p",
        },
        cycle_error_s: {
            img: document.getElementById("diagnostics-p-cycle-img"),
            caption: document.getElementById("diagnostics-p-cycle-caption"),
            header: document.getElementById("diagnostics-p-cycle-header"),
            title: "Cycle error (P)",
            label: "vis_cycle_error_p",
        },
        straightline_s: {
            img: document.getElementById("diagnostics-p-straightline-img"),
            caption: document.getElementById("diagnostics-p-straightline-caption"),
            header: document.getElementById("diagnostics-p-straightline-header"),
            title: "Straight-line action rays (P)",
            label: "vis_straightline_p",
        },
    };

    const targetsF = {
        delta_f_pca: {
            img: document.getElementById("diagnostics-f-delta-img"),
            caption: document.getElementById("diagnostics-f-delta-caption"),
            header: document.getElementById("diagnostics-f-delta-header"),
            title: "Delta-f PCA",
            label: "vis_delta_f_pca",
        },
        action_alignment_detail_f: {
            img: document.getElementById("diagnostics-f-align-img"),
            caption: document.getElementById("diagnostics-f-align-caption"),
            header: document.getElementById("diagnostics-f-align-header"),
            title: "Action alignment (F)",
            label: "action alignment (F)",
        },
        self_distance_f: {
            img: document.getElementById("diagnostics-f-self-img"),
            caption: document.getElementById("diagnostics-f-self-caption"),
            header: document.getElementById("diagnostics-f-self-header"),
            title: "Self-distance (F)",
            label: "self_distance_f",
        },
        cycle_error_f: {
            img: document.getElementById("diagnostics-f-cycle-img"),
            caption: document.getElementById("diagnostics-f-cycle-caption"),
            header: document.getElementById("diagnostics-f-cycle-header"),
            title: "Cycle error (F)",
            label: "vis_cycle_error_f",
        },
    };

    const targetsH = {
        delta_h_pca: {
            img: document.getElementById("diagnostics-h-delta-img"),
            caption: document.getElementById("diagnostics-h-delta-caption"),
            header: document.getElementById("diagnostics-h-delta-header"),
            title: "Delta-h PCA",
            label: "vis_delta_h_pca",
        },
        action_alignment_detail_h: {
            img: document.getElementById("diagnostics-h-align-img"),
            caption: document.getElementById("diagnostics-h-align-caption"),
            header: document.getElementById("diagnostics-h-align-header"),
            title: "Action alignment (H)",
            label: "action alignment (H)",
        },
        self_distance_h: {
            img: document.getElementById("diagnostics-h-self-img"),
            caption: document.getElementById("diagnostics-h-self-caption"),
            header: document.getElementById("diagnostics-h-self-header"),
            title: "Self-distance (H)",
            label: "self_distance_h",
        },
        cycle_error_h: {
            img: document.getElementById("diagnostics-h-cycle-img"),
            caption: document.getElementById("diagnostics-h-cycle-caption"),
            header: document.getElementById("diagnostics-h-cycle-header"),
            title: "Cycle error (H)",
            label: "vis_cycle_error_h",
        },
        h_ablation: {
            img: document.getElementById("diagnostics-h-ablation-img"),
            caption: document.getElementById("diagnostics-h-ablation-caption"),
            header: document.getElementById("diagnostics-h-ablation-header"),
            title: "H ablation divergence",
            label: "vis_h_ablation",
        },
        h_drift_by_action: {
            img: document.getElementById("diagnostics-h-drift-img"),
            caption: document.getElementById("diagnostics-h-drift-caption"),
            header: document.getElementById("diagnostics-h-drift-header"),
            title: "H drift by action",
            label: "vis_h_drift_by_action",
        },
        norm_timeseries: {
            img: document.getElementById("diagnostics-h-norm-img"),
            caption: document.getElementById("diagnostics-h-norm-caption"),
            header: document.getElementById("diagnostics-h-norm-header"),
            title: "Norm stability",
            label: "vis_norm_timeseries",
        },
    };

    const statusItems = document.querySelectorAll("[data-status-metric]");
    const scalarSteps = Object.keys(diagnosticsScalars).map((k) => Number(k)).filter((n) => !Number.isNaN(n)).sort((a, b) => a - b);

    function formatScalar(value) {
        if (value === null || value === undefined) return "—";
        const num = Number(value);
        if (!Number.isFinite(num)) return "—";
        return num.toFixed(3);
    }

    function nearestScalarStep(target) {
        if (!scalarSteps.length) return null;
        let best = null;
        for (let i = 0; i < scalarSteps.length; i++) {
            const step = scalarSteps[i];
            if (step > target) {
                continue;
            }
            if (best === null || step > best) {
                best = step;
            }
        }
        return best;
    }

    function updateStatusStrip(stepValue) {
        if (!statusItems.length) return;
        if (!scalarSteps.length) return;
        const nearest = nearestScalarStep(stepValue);
        const step = nearest !== null ? nearest : scalarSteps[scalarSteps.length - 1];
        const values = diagnosticsScalars[step] || {};
        statusItems.forEach((item) => {
            const key = item.getAttribute("data-status-metric");
            if (!key) return;
            item.textContent = formatScalar(values[key]);
        });
    }

    function resolveUrl(diagMap, diagKey, step) {
        const perDiag = diagMap[diagKey] || {};
        return perDiag[step] || perDiag[String(step)] || null;
    }

    function updateTargets(step, targetMap, mapData) {
        Object.entries(targetMap).forEach(([key, refs]) => {
            if (!refs.img || !refs.caption) return;
            const url = resolveUrl(mapData, key, step);
            const headerText = refs.title ? refs.title : "";
            if (url) {
                refs.img.src = url;
                refs.img.classList.remove("d-none");
                if (refs.header && refs.title) {
                    const headerTitle = refs.header.querySelector(".image-preview-card-title");
                    if (headerTitle) {
                        headerTitle.textContent = headerText;
                    }
                }
                refs.caption.textContent = "";
            } else {
                refs.img.classList.add("d-none");
                refs.caption.textContent = `No image for step ${step} in ${refs.label}`;
            }
        });
    }

    function nearestStepAtOrBelow(target) {
        if (!steps.length) return null;
        let best = null;
        for (let i = 0; i < steps.length; i++) {
            const step = steps[i];
            if (step > target) {
                continue;
            }
            if (best === null || step > best) {
                best = step;
            }
        }
        return best;
    }

    function updateForStep(stepValue) {
        const nearest = nearestStepAtOrBelow(stepValue);
        const step = nearest !== null ? nearest : steps[steps.length - 1];
        stepLabels.forEach((label) => {
            label.textContent = step ?? "—";
        });
        updateTargets(step, targetsZ, diagnosticsZ);
        updateTargets(step, targetsH, diagnosticsH);
        updateTargets(step, targetsP, diagnosticsP);
        updateTargets(step, targetsF, diagnosticsF);
        updateStatusStrip(step ?? 0);
    }

    function renderLossPlot() {
        if (!lossPlot) return;
        if (typeof Plotly === "undefined") {
            return;
        }
        if (!figure || !figure.data || !figure.layout) {
            return;
        }
        const layout = {
            ...figure.layout,
            height: 220,
            margin: { ...(figure.layout?.margin || {}), t: 30, b: 50, l: 50, r: 10 },
        };
        const config = buildPlotlyConfig(figure.config || {});
        Plotly.react(lossPlot, figure.data, layout, config).then(() => {
            lossPlot.on("plotly_hover", (event) => {
                const point = event?.points?.[0];
                if (!point || typeof point.x === "undefined") return;
                updateForStep(point.x);
            });
        });
    }

    function setLossPinned(pinned) {
        if (!lossWrapper || !lossPinButton) return;
        lossPinned = pinned;
        lossWrapper.classList.toggle("sticky-active", pinned);
        lossPinButton.classList.toggle("active", pinned);
        lossPinButton.setAttribute("aria-pressed", pinned ? "true" : "false");
        lossPinButton.setAttribute("title", pinned ? "Unpin diagnostics plot" : "Pin diagnostics plot");
    }

    setLossPinned(true);
    renderLossPlot();

    const initialStep = steps.length ? steps[steps.length - 1] : null;
    if (initialStep !== null) {
        updateForStep(initialStep);
    }

    if (lossPinButton && lossWrapper) {
        lossPinButton.addEventListener("click", () => {
            setLossPinned(!lossPinned);
        });
    }
});
</script>
{% endif %}
{% endblock %}
