{% extends "base.html" %}

{% block extra_head %}
<script src="https://cdn.plot.ly/plotly-2.27.0.min.js"></script>
<script src="{{ url_for('static', filename='plotly_utils.js') }}"></script>
{% endblock %}

{% block body %}
<style>
.odometry-grid {
    display: grid;
    grid-template-columns: repeat(12, minmax(110px, 1fr));
    gap: 1rem;
}
.odometry-span-3 {
    grid-column: span 3;
}
.odometry-span-4 {
    grid-column: span 4;
}
.odometry-card-img {
    width: 100%;
    height: auto;
    border: 1px solid #e9ecef;
    border-radius: 0.5rem;
    background: #f8f9fa;
}
.odometry-loss-plot {
    height: 220px;
}
.odometry-plot-wrapper {
    position: relative;
}
.odometry-pin-btn {
    position: absolute;
    bottom: 10px;
    right: 10px;
    width: 32px;
    height: 32px;
    border-radius: 999px;
    display: inline-flex;
    align-items: center;
    justify-content: center;
    background-color: rgba(255, 255, 255, 0.9);
    border: 1px solid #ced4da;
    color: #6c757d;
    z-index: 5;
    box-shadow: 0 2px 6px rgba(0, 0, 0, 0.08);
    transition: transform 0.15s ease-in-out, box-shadow 0.15s ease-in-out, background-color 0.15s ease-in-out, color 0.15s ease-in-out, border-color 0.15s ease-in-out;
}
.odometry-pin-btn:hover {
    transform: translateY(-1px);
    box-shadow: 0 4px 10px rgba(0, 0, 0, 0.12);
}
.odometry-pin-btn.active {
    background-color: #0d6efd;
    border-color: #0a58ca;
    color: #fff;
}
.odometry-plot-wrapper.sticky-active {
    position: sticky;
    top: 0;
    z-index: 1030;
    background: #fff;
    border-radius: 0.5rem;
    box-shadow: 0 0.5rem 1rem rgba(0, 0, 0, 0.08);
}
.odometry-info-icon {
    display: inline-flex;
    align-items: center;
    justify-content: center;
    width: 18px;
    height: 18px;
    border-radius: 999px;
    background: #eef2ff;
    color: #3949ab;
    font-size: 12px;
    border: 1px solid #c5cae9;
    cursor: pointer;
}
@media (max-width: 768px) {
    .odometry-grid {
        grid-template-columns: 1fr;
    }
}
</style>
<div class="d-flex align-items-center justify-content-between flex-wrap gap-2 mb-3">
    <div>
        {% if experiment %}
        <h3 class="mb-1">{{ experiment.title if experiment.title != "Untitled" else "Untitled" }} <small class="text-muted">({{ experiment.id }})</small></h3>
        {% else %}
        <h3 class="mb-1">{{ page_title if page_title is defined else "Odometry" }}</h3>
        {% endif %}
    </div>
    {% if experiment %}
    <div class="d-flex align-items-center gap-2 flex-wrap">
        <a class="btn btn-outline-secondary btn-sm" href="{{ url_for('experiment_detail', exp_id=experiment.id) }}">Open experiment</a>
    </div>
    {% endif %}
</div>

{% if not experiment %}
<div class="text-muted fst-italic">No experiments available.</div>
{% else %}
<div class="card mb-3 odometry-plot-wrapper sticky-active" id="odometry-plot-wrapper">
    <button
        type="button"
        class="odometry-pin-btn active"
        id="odometry-plot-pin"
        aria-pressed="true"
        aria-label="Pin odometry plot"
        title="Unpin odometry plot"
    >
        <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="currentColor" viewBox="0 0 16 16">
            <path d="M4.146.146A.5.5 0 0 1 4.5 0h7a.5.5 0 0 1 .5.5c0 .68-.342 1.174-.646 1.479-.126.125-.25.224-.354.298v4.431l.078.048c.203.127.476.314.751.555C12.36 7.775 13 8.527 13 9.5a.5.5 0 0 1-.5.5h-4v4.5c0 .276-.224 1.5-.5 1.5s-.5-1.224-.5-1.5V10h-4a.5.5 0 0 1-.5-.5c0-.973.64-1.725 1.17-2.189A6 6 0 0 1 5 6.708V2.277a3 3 0 0 1-.354-.298C4.342 1.674 4 1.179 4 .5a.5.5 0 0 1 .146-.354"/>
        </svg>
    </button>
    <div class="card-header py-2 d-flex align-items-center gap-2">
        <strong>Training metrics</strong>
        {% if odometry_steps %}
        <span class="text-muted small">hover to scrub steps</span>
        <span class="ms-auto text-muted small">Step: <span id="odometry-step-label" class="odometry-step-label">{{ odometry_steps[-1] }}</span></span>
        {% endif %}
    </div>
    <div class="card-body">
        <div id="odometry-loss-plot" class="odometry-loss-plot"></div>
    </div>
</div>

<div class="odometry-grid">
    <div class="card h-100">
        <div class="card-header py-2 d-flex justify-content-between align-items-center">
            <span>PCA z</span>
            <div class="d-flex align-items-center gap-2">
                <span class="text-muted small">Step: <span class="odometry-step-label">—</span></span>
                <span
                    class="odometry-info-icon"
                    data-bs-toggle="tooltip"
                    data-bs-placement="left"
                    title="PCA projection of z embeddings across the sequence. Read: orderly gradients indicate structured latent geometry; scattered clouds suggest instability. Good: smooth progression with limited overlap."
                >i</span>
            </div>
        </div>
        <div class="card-body">
            {% if not odometry_steps %}
            <div class="text-muted fst-italic small">
                {% if experiment %}
                No PCA images found in experiment {{ experiment.id }}.
                {% else %}
                No PCA images found in any experiments.
                {% endif %}
            </div>
            {% else %}
            <img id="odometry-pca-z-img" class="odometry-card-img d-none" alt="PCA z">
            <div class="text-muted small" id="odometry-pca-z-caption"></div>
            {% endif %}
        </div>
    </div>
    <div class="card h-100 odometry-span-3">
        <div class="card-header py-2 d-flex justify-content-between align-items-center">
            <span>Cumulative sum of Δz PCA/ICA/t-SNE</span>
            <div class="d-flex align-items-center gap-2">
                <span class="text-muted small">Step: <span class="odometry-step-label">—</span></span>
                <span
                    class="odometry-info-icon"
                    data-bs-toggle="tooltip"
                    data-bs-placement="left"
                    title="Trajectory of cumulative delta-z over time (after warmup), projected with PCA/ICA/t-SNE. Read: smooth curves and consistent drift indicate stable dynamics; sharp jumps or tangled loops suggest instability. Good: coherent, continuous trajectory with gradual drift."
                >i</span>
            </div>
        </div>
        <div class="card-body">
            {% if not odometry_steps %}
            <div class="text-muted fst-italic small">
                {% if experiment %}
                No vis_odometry images found in experiment {{ experiment.id }}.
                {% else %}
                No vis_odometry images found in any experiments.
                {% endif %}
            </div>
            {% else %}
            <img id="odometry-z-img" class="odometry-card-img d-none" alt="odometry z">
            <div class="text-muted small" id="odometry-z-caption"></div>
            {% endif %}
        </div>
    </div>
    <div class="card h-100">
        <div class="card-header py-2 d-flex justify-content-between align-items-center">
            <span>PCA s</span>
            <div class="d-flex align-items-center gap-2">
                <span class="text-muted small">Step: <span class="odometry-step-label">—</span></span>
                <span
                    class="odometry-info-icon"
                    data-bs-toggle="tooltip"
                    data-bs-placement="left"
                    title="PCA projection of s embeddings across the sequence. Read: orderly gradients indicate structured latent geometry; scattered clouds suggest instability. Good: smooth progression with limited overlap."
                >i</span>
            </div>
        </div>
        <div class="card-body">
            {% if not odometry_steps %}
            <div class="text-muted fst-italic small">
                {% if experiment %}
                No PCA images found in experiment {{ experiment.id }}.
                {% else %}
                No PCA images found in any experiments.
                {% endif %}
            </div>
            {% else %}
            <img id="odometry-pca-s-img" class="odometry-card-img d-none" alt="PCA s">
            <div class="text-muted small" id="odometry-pca-s-caption"></div>
            {% endif %}
        </div>
    </div>
    <div class="card h-100 odometry-span-3">
        <div class="card-header py-2 d-flex justify-content-between align-items-center">
            <span>Cumulative sum of Δs PCA/ICA/t-SNE</span>
            <div class="d-flex align-items-center gap-2">
                <span class="text-muted small">Step: <span class="odometry-step-label">—</span></span>
                <span
                    class="odometry-info-icon"
                    data-bs-toggle="tooltip"
                    data-bs-placement="left"
                    title="Trajectory of cumulative delta-s over time (after warmup), projected with PCA/ICA/t-SNE. Read: smooth curves and consistent drift indicate stable dynamics; sharp jumps or tangled loops suggest instability. Good: coherent, continuous trajectory with gradual drift."
                >i</span>
            </div>
        </div>
        <div class="card-body">
            {% if not odometry_steps %}
            <div class="text-muted fst-italic small">
                {% if experiment %}
                No vis_odometry images found in experiment {{ experiment.id }}.
                {% else %}
                No vis_odometry images found in any experiments.
                {% endif %}
            </div>
            {% else %}
            <img id="odometry-s-img" class="odometry-card-img d-none" alt="odometry s">
            <div class="text-muted small" id="odometry-s-caption"></div>
            {% endif %}
        </div>
    </div>
    <div class="card h-100">
        <div class="card-header py-2 d-flex justify-content-between align-items-center">
            <span>PCA h</span>
            <div class="d-flex align-items-center gap-2">
                <span class="text-muted small">Step: <span class="odometry-step-label">—</span></span>
                <span
                    class="odometry-info-icon"
                    data-bs-toggle="tooltip"
                    data-bs-placement="left"
                    title="PCA projection of h embeddings across the sequence. Read: orderly gradients indicate structured latent geometry; scattered clouds suggest instability. Good: smooth progression with limited overlap."
                >i</span>
            </div>
        </div>
        <div class="card-body">
            {% if not odometry_steps %}
            <div class="text-muted fst-italic small">
                {% if experiment %}
                No PCA images found in experiment {{ experiment.id }}.
                {% else %}
                No PCA images found in any experiments.
                {% endif %}
            </div>
            {% else %}
            <img id="odometry-pca-h-img" class="odometry-card-img d-none" alt="PCA h">
            <div class="text-muted small" id="odometry-pca-h-caption"></div>
            {% endif %}
        </div>
    </div>
    <div class="card h-100 odometry-span-3">
        <div class="card-header py-2 d-flex justify-content-between align-items-center">
            <span>Cumulative sum of Δh PCA/ICA/t-SNE</span>
            <div class="d-flex align-items-center gap-2">
                <span class="text-muted small">Step: <span class="odometry-step-label">—</span></span>
                <span
                    class="odometry-info-icon"
                    data-bs-toggle="tooltip"
                    data-bs-placement="left"
                    title="Trajectory of cumulative delta-h over time (after warmup), projected with PCA/ICA/t-SNE. Read: smooth curves and consistent drift indicate stable dynamics; sharp jumps or tangled loops suggest instability. Good: coherent, continuous trajectory with gradual drift."
                >i</span>
            </div>
        </div>
        <div class="card-body">
            {% if not odometry_steps %}
            <div class="text-muted fst-italic small">
                {% if experiment %}
                No vis_odometry images found in experiment {{ experiment.id }}.
                {% else %}
                No vis_odometry images found in any experiments.
                {% endif %}
            </div>
            {% else %}
            <img id="odometry-h-img" class="odometry-card-img d-none" alt="odometry h">
            <div class="text-muted small" id="odometry-h-caption"></div>
            {% endif %}
        </div>
    </div>
    <div class="card h-100 odometry-span-4">
        <div class="card-header py-2 d-flex justify-content-between align-items-center">
            <span>||z - z_hat|| + scatter</span>
            <div class="d-flex align-items-center gap-2">
                <span class="text-muted small">Step: <span class="odometry-step-label">—</span></span>
                <span
                    class="odometry-info-icon"
                    data-bs-toggle="tooltip"
                    data-bs-placement="left"
                    title="Predictor error norm over time plus a z vs. z_hat scatter view. Read: the line shows ||z - z_hat|| per step; the scatter should hug the diagonal. Good: low, stable error and tight diagonal scatter."
                >i</span>
            </div>
        </div>
        <div class="card-body">
            {% if not odometry_steps %}
            <div class="text-muted fst-italic small">
                {% if experiment %}
                No vis_odometry images found in experiment {{ experiment.id }}.
                {% else %}
                No vis_odometry images found in any experiments.
                {% endif %}
            </div>
            {% else %}
            <img id="odometry-zhat-img" class="odometry-card-img d-none" alt="z vs z_hat">
            <div class="text-muted small" id="odometry-zhat-caption"></div>
            {% endif %}
        </div>
    </div>
    <div class="card h-100 odometry-span-4">
        <div class="card-header py-2 d-flex justify-content-between align-items-center">
            <span>||s - s_hat|| + scatter</span>
            <div class="d-flex align-items-center gap-2">
                <span class="text-muted small">Step: <span class="odometry-step-label">—</span></span>
                <span
                    class="odometry-info-icon"
                    data-bs-toggle="tooltip"
                    data-bs-placement="left"
                    title="Predictor error norm over time plus an s vs. s_hat scatter view. Read: the line shows ||s - s_hat|| per step; the scatter should hug the diagonal. Good: low, stable error and tight diagonal scatter."
                >i</span>
            </div>
        </div>
        <div class="card-body">
            {% if not odometry_steps %}
            <div class="text-muted fst-italic small">
                {% if experiment %}
                No vis_odometry images found in experiment {{ experiment.id }}.
                {% else %}
                No vis_odometry images found in any experiments.
                {% endif %}
            </div>
            {% else %}
            <img id="odometry-shat-img" class="odometry-card-img d-none" alt="s vs s_hat">
            <div class="text-muted small" id="odometry-shat-caption"></div>
            {% endif %}
        </div>
    </div>
    <div class="card h-100 odometry-span-4">
        <div class="card-header py-2 d-flex justify-content-between align-items-center">
            <span>||h - h_hat|| + scatter</span>
            <div class="d-flex align-items-center gap-2">
                <span class="text-muted small">Step: <span class="odometry-step-label">—</span></span>
                <span
                    class="odometry-info-icon"
                    data-bs-toggle="tooltip"
                    data-bs-placement="left"
                    title="Predictor error norm over time plus an h vs. h_hat scatter view. Read: the line shows ||h - h_hat|| per step; the scatter should hug the diagonal. Good: low, stable error and tight diagonal scatter."
                >i</span>
            </div>
        </div>
        <div class="card-body">
            {% if not odometry_steps %}
            <div class="text-muted fst-italic small">
                {% if experiment %}
                No vis_odometry images found in experiment {{ experiment.id }}.
                {% else %}
                No vis_odometry images found in any experiments.
                {% endif %}
            </div>
            {% else %}
            <img id="odometry-hhat-img" class="odometry-card-img d-none" alt="h vs h_hat">
            <div class="text-muted small" id="odometry-hhat-caption"></div>
            {% endif %}
        </div>
    </div>
</div>
{% endif %}
{% endblock %}

{% block extra_scripts %}
<script>
document.addEventListener("DOMContentLoaded", () => {
    const tooltipTriggerList = Array.from(document.querySelectorAll('[data-bs-toggle="tooltip"]'));
    tooltipTriggerList.forEach((el) => {
        if (window.bootstrap) {
            new bootstrap.Tooltip(el);
        }
    });
});
</script>
{% if experiment %}
<script>
document.addEventListener("DOMContentLoaded", () => {
    const lossPlot = document.getElementById("odometry-loss-plot");
    const figure = {{ figure | tojson if figure else 'null' }};
    const steps = {{ odometry_steps | tojson }};
    const odometryMap = {{ odometry_map | tojson }};
    const stepLabels = document.querySelectorAll(".odometry-step-label");
    const plotWrapper = document.getElementById("odometry-plot-wrapper");
    const plotPinButton = document.getElementById("odometry-plot-pin");
    let plotPinned = true;
    const targets = {
        pca_z: {img: document.getElementById("odometry-pca-z-img"), caption: document.getElementById("odometry-pca-z-caption")},
        odometry_z: {img: document.getElementById("odometry-z-img"), caption: document.getElementById("odometry-z-caption")},
        pca_s: {img: document.getElementById("odometry-pca-s-img"), caption: document.getElementById("odometry-pca-s-caption")},
        odometry_s: {img: document.getElementById("odometry-s-img"), caption: document.getElementById("odometry-s-caption")},
        pca_h: {img: document.getElementById("odometry-pca-h-img"), caption: document.getElementById("odometry-pca-h-caption")},
        odometry_h: {img: document.getElementById("odometry-h-img"), caption: document.getElementById("odometry-h-caption")},
        z_vs_z_hat: {img: document.getElementById("odometry-zhat-img"), caption: document.getElementById("odometry-zhat-caption")},
        s_vs_s_hat: {img: document.getElementById("odometry-shat-img"), caption: document.getElementById("odometry-shat-caption")},
        h_vs_h_hat: {img: document.getElementById("odometry-hhat-img"), caption: document.getElementById("odometry-hhat-caption")},
    };
    let pinnedStep = steps.length ? steps[steps.length - 1] : null;

    function updatePinState(nextState) {
        plotPinned = nextState;
        if (!plotWrapper || !plotPinButton) return;
        plotWrapper.classList.toggle("sticky-active", plotPinned);
        plotPinButton.classList.toggle("active", plotPinned);
        plotPinButton.setAttribute("aria-pressed", plotPinned ? "true" : "false");
        plotPinButton.setAttribute("title", plotPinned ? "Unpin odometry plot" : "Pin odometry plot");
    }

    if (plotPinButton) {
        plotPinButton.addEventListener("click", () => {
            updatePinState(!plotPinned);
        });
    }

    function nearestStepAtOrBelow(value) {
        if (!steps.length) return null;
        let best = null;
        for (let i = 0; i < steps.length; i++) {
            const step = steps[i];
            if (step > value) {
                continue;
            }
            if (best === null || step > best) {
                best = step;
            }
        }
        return best;
    }

    function resolveUrl(key, step) {
        const perStep = odometryMap[step] || odometryMap[String(step)] || {};
        return perStep[key] || null;
    }

    function updateImages(step) {
        if (!step) {
            return;
        }
        stepLabels.forEach((label) => {
            label.textContent = step;
        });
        Object.entries(targets).forEach(([key, refs]) => {
            if (!refs.img || !refs.caption) return;
            const url = resolveUrl(key, step);
            if (url) {
                refs.img.src = url;
                refs.img.classList.remove("d-none");
                refs.caption.textContent = "";
            } else {
                refs.img.classList.add("d-none");
                refs.caption.textContent = `Missing ${key} image for step ${step}`;
            }
        });
    }

    if (!lossPlot || typeof Plotly === "undefined") return;
    if (!figure || !figure.data || !figure.layout) {
        lossPlot.innerHTML = "<div class='text-muted fst-italic small'>Loss plot not available.</div>";
        updateImages(pinnedStep);
        return;
    }
    const layout = {
        ...figure.layout,
        height: 220,
        margin: { ...(figure.layout?.margin || {}), t: 30, b: 50, l: 50, r: 10 },
    };
    const config = buildPlotlyConfig(figure.config || {});
    Plotly.react(lossPlot, figure.data, layout, config).then(() => {
        lossPlot.on("plotly_hover", (event) => {
            const point = event?.points?.[0];
            if (!point || typeof point.x === "undefined") return;
            const nearest = nearestStepAtOrBelow(point.x);
            if (nearest !== null) {
                pinnedStep = nearest;
                updateImages(pinnedStep);
            }
        });
    });
    updateImages(pinnedStep);
    updatePinState(true);
});
</script>
{% endif %}
{% endblock %}
